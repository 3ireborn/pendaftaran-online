<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NPA Smart System ‚Äî Admin Pusat v4.7 AUTO (Final)</title>
<style>
  :root{
    --brand:#0b5bd3; --brand2:#EAF2FF; --txt:#0f172a; --muted:#64748b; --ok:#22c55e; --warn:#f59e0b; --bg:#f6faff;
  }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#fff;color:var(--txt)}
  header{background:linear-gradient(180deg,#0d47a1,#0b5bd3);color:#fff;padding:20px}
  h1{margin:0;font-size:24px;font-weight:800}
  .sub{opacity:.9;margin-top:4px;font-size:14px}
  .wrap{max-width:880px;margin:18px auto;padding:0 14px}
  .card{background:#fff;border:1px solid #e5eefb;border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(13,71,161,.06);margin-bottom:14px}
  .ttl{font-weight:800;font-size:18px;margin:0 0 12px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input,select{width:100%;padding:12px;border:1px solid #dbe7ff;border-radius:10px;font-size:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
  .btn{background:var(--brand);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.alt{background:#fff;color:var(--brand);border:1px solid #cfe0ff}
  .btn.ghost{background:var(--brand2);color:var(--brand)}
  .pill{display:inline-block;background:#eef5ff;border:1px solid #dbe7ff;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:13px}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .grid3{display:grid;gap:8px}
  @media(min-width:720px){.grid3{grid-template-columns:repeat(3,1fr)}}
  .log{white-space:pre-wrap;background:var(--bg);border:1px solid #e7f0ff;border-radius:12px;padding:10px;max-height:320px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px}
  .botbar{position:sticky;bottom:10px;z-index:5;border-radius:16px;display:flex;align-items:center;gap:8px;background:#0b3d91;color:#fff;padding:10px 12px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#bbb}
  .dot.ok{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25)}
  .switch{display:flex;align-items:center;gap:6px}
  .switch input{accent-color:#22c55e;width:18px;height:18px}
  small.code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<header>
  <h1>NPA Smart System ‚Äî Admin Pusat v4.7 AUTO</h1>
  <div class="sub">Sederhana ‚Ä¢ Light-Blue ‚Ä¢ Autopilot: Motivasi 06:00 WIB + Follow-Up 10/15/18/29 ‚Ä¢ Manual mode siap pakai</div>
</header>

<div class="wrap">

  <!-- Tambah Mitra -->
  <section class="card">
    <div class="ttl">‚ûï Tambah Mitra/Leader</div>
    <div class="row">
      <div>
        <label>Nama Leader</label>
        <input id="inName" placeholder="cth: Sugiarto Kurniawan" />
      </div>
      <div>
        <label>No. WhatsApp (format 62‚Ä¶)</label>
        <input id="inPhone" placeholder="cth: 6285xxxxxxxx" />
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnAdd">Tambah</button>
      <span class="muted">ID/kode/slug dibuat otomatis. Setelah tambah, langsung dapat 3 link siap share.</span>
    </div>
    <div id="linksBox" style="margin-top:12px;display:none">
      <div class="ttl" style="font-size:16px;margin-bottom:8px">üîó Tautan Pribadi</div>
      <div class="grid3" id="linksList"></div>
    </div>
  </section>

  <!-- Sinkron GitHub -->
  <section class="card">
    <div class="ttl">üå•Ô∏è Sinkron ke GitHub (opsional)</div>
    <div class="row">
      <div>
        <label>Owner/Org</label>
        <input id="ghOwner" value="3ireborn" />
      </div>
      <div>
        <label>Repository</label>
        <input id="ghRepo" value="pendaftaran-online" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Path file leaders.json</label>
        <input id="ghPath" value="data/leaders.json" />
      </div>
      <div>
        <label>Token GitHub (disimpan lokal)</label>
        <input id="ghToken" placeholder="ghp_xxx‚Ä¶" />
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn alt" id="btnSaveGh">Simpan Token</button>
      <button class="btn" id="btnSync">Sinkron ke GitHub</button>
      <span class="muted">Token hanya disimpan di perangkat ini (<code class="code">localStorage</code>).</span>
    </div>
  </section>

  <!-- BOT Monitor -->
  <section class="card">
    <div class="ttl">ü§ñ Fonnte BOT ‚Ä¢ Broadcast & Follow-Up</div>
    <div class="botbar">
      <span class="dot" id="dotTok"></span>
      <b style="margin-right:auto">NPA BOT ¬∑ <span id="wibNow">WIB</span></b>
      <button class="btn alt" id="btnSetF">Set Token</button>
      <button class="btn alt" id="btnTest">Tes</button>
      <button class="btn" id="btnBc">Broadcast</button>
      <button class="btn ghost" id="btnFU">FollowUp Now</button>
      <label class="switch"><input type="checkbox" id="auto06" checked>Auto 06:00</label>
      <label class="switch"><input type="checkbox" id="autoFU" checked>Auto Follow-Up</label>
    </div>
    <div class="log" id="log"></div>
    <div class="muted" style="margin-top:8px">
      #Terkirim dengan üíû dari NPA Smart System, Semangat Menembus Batas üöÄ
    </div>
  </section>

  <section class="card">
    <div class="ttl">‚ÑπÔ∏è Bantuan</div>
    <div class="muted">
      ‚Ä¢ Tambah mitra ‚Üí otomatis dapat 3 link (LP Master / LP Hot / Form Pendaftaran).<br/>
      ‚Ä¢ Klik <b>Set Token</b> untuk Fonnte (sekali embed sudah terpasang). <br/>
      ‚Ä¢ <b>Auto 06:00</b> mengirim motivasi harian.<br/>
      ‚Ä¢ <b>Auto Follow-Up</b> jalan tanggal: <b>10 / 15 / 18 / 29</b> (jam 08:00 WIB).<br/>
      ‚Ä¢ Manual: <b>Broadcast</b> & <b>FollowUp Now</b> kapan saja.
    </div>
  </section>

  <footer class="muted" style="text-align:center;padding:18px 6px">
    Powered by <b>NPA Smart System √ó 3iReborn</b> ‚Äî ‚ÄúKitaNganggur Punya Penghasilan‚Äù üöÄ
  </footer>
</div>

<script>
/* =========================
   NPA Smart System ‚Äî v4.7 AUTO
   ========================= */
const UI = {
  inName:  document.getElementById('inName'),
  inPhone: document.getElementById('inPhone'),
  linksBox:document.getElementById('linksBox'),
  linksList:document.getElementById('linksList'),
  ghOwner: document.getElementById('ghOwner'),
  ghRepo:  document.getElementById('ghRepo'),
  ghPath:  document.getElementById('ghPath'),
  ghToken: document.getElementById('ghToken'),
  log:     document.getElementById('log'),
  dotTok:  document.getElementById('dotTok'),
  wibNow:  document.getElementById('wibNow'),
  auto06:  document.getElementById('auto06'),
  autoFU:  document.getElementById('autoFU'),
};
const STORE = {
  GITHUB_TOKEN_KEY:'npa_gh_token',
  FONNTE_TOKEN_KEY:'npa_fonnte_token',
  leadersCache: [],
};
// ====== TOKENS ======
// FONNTE token di-embed SEKALI (sesuai permintaan).
const FONNTE_TOKEN_EMBED = "a2vtTGhWMnWxFZtxw1U1";

// ====== HELPERS ======
const tz = "Asia/Jakarta";
function nowWIB(){ return new Date(new Date().toLocaleString("en-US",{timeZone:tz})); }
function tpad(n){ return n.toString().padStart(2,'0'); }
function log(line){
  const t = nowWIB(); const hh=tpad(t.getHours()), mm=tpad(t.getMinutes()), ss=tpad(t.getSeconds());
  UI.log.textContent = `[${hh}.${mm}.${ss}] ${line}\n` + UI.log.textContent;
}
function saveLocal(k,v){ localStorage.setItem(k, v); }
function readLocal(k){ return localStorage.getItem(k)||""; }
function paintDot(){
  UI.dotTok.className='dot ' + (readLocal(STORE.FONNTE_TOKEN_KEY) ? 'ok' : '');
}

// ====== LINK BUILDER ======
function slugify(n){ return n.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
function buildLinks(name, phone){
  const slug = slugify(name);
  const base = 'https://3ireborn.github.io/pendaftaran-online/';
  return [
    {label:'LP Master', url: base + 'master-lp.html?leader='+slug},
    {label:'LP Hot',    url: base + 'lp-hot-mini.html?leader='+slug},
    {label:'Pendaftaran', url: base + 'index-v2.html?leader='+slug}
  ];
}

// ====== ADD LEADER (local + show links) ======
document.getElementById('btnAdd').onclick = () => {
  const name = UI.inName.value.trim();
  const phone= UI.inPhone.value.trim();
  if(!name || !/^62\d{6,}$/.test(phone)) { alert('Nama & No WA (format 62‚Ä¶) wajib benar.'); return; }

  // tampilkan 3 link siap share
  const links = buildLinks(name, phone);
  UI.linksList.innerHTML = links.map(l => `
    <a class="pill" target="_blank" href="${l.url}">${l.label}</a>
  `).join('');
  UI.linksBox.style.display='block';
  log(`‚ú® Leader ‚Äú${name}‚Äù dibuat local. Klik Sinkron untuk simpan ke GitHub (opsional).`);

  // taruh ke cache (optional sinkron)
  STORE.leadersCache.push({id:"", code:"", name, phone, slug:slugify(name)});
};

// ====== GITHUB SYNC (optional) ======
UI.ghToken.value = readLocal(STORE.GITHUB_TOKEN_KEY);
document.getElementById('btnSaveGh').onclick = ()=>{
  saveLocal(STORE.GITHUB_TOKEN_KEY, UI.ghToken.value.trim());
  alert('Token GitHub tersimpan di perangkat ini.');
};
async function fetchLeadersRaw(){
  // ambil dari raw repo agar daftar lengkap untuk broadcast
  const raw = `https://raw.githubusercontent.com/${UI.ghOwner.value}/${UI.ghRepo.value}/main/${UI.ghPath.value}`;
  const res = await fetch(raw, {cache:'no-store'});
  if(res.ok){ return res.json(); }
  return [];
}
async function pushLeadersToGitHub(){
  const token = readLocal(STORE.GITHUB_TOKEN_KEY);
  if(!token){ alert('Isi Token GitHub dulu.'); return; }
  // ambil isi saat ini
  const api = `https://api.github.com/repos/${UI.ghOwner.value}/${UI.ghRepo.value}/contents/${UI.ghPath.value}`;
  const cur = await fetch(api).then(r=>r.json());
  let current = [];
  try{
    const raw = await fetchLeadersRaw();
    if(Array.isArray(raw)) current = raw;
  }catch(_){}
  // gabung cache baru (jika ada)
  const merged = current.concat(STORE.leadersCache);
  const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(merged,null,2))));
  const body = {
    message: "update leaders via admin v4.7 AUTO",
    content: newContent,
    sha: cur.sha
  };
  const res = await fetch(api,{method:'PUT',headers:{
    'Authorization': `Bearer ${token}`,
    'Content-Type':'application/json'
  }, body: JSON.stringify(body)});
  if(!res.ok){ throw new Error('Gagal push ke GitHub'); }
  alert('Sinkron GitHub BERHASIL ‚úÖ');
  STORE.leadersCache = []; // clear
}
document.getElementById('btnSync').onclick = ()=>{ pushLeadersToGitHub().catch(e=>alert(e.message)); };

// ====== FONNTE ======
function currentFonnteToken(){
  // prioritas: localStorage; fallback: embed
  return readLocal(STORE.FONNTE_TOKEN_KEY) || FONNTE_TOKEN_EMBED;
}
async function sendFonnte(target, message){
  const token = currentFonnteToken();
  if(!token) throw new Error('Token Fonnte kosong');
  const res = await fetch("https://api.fonnte.com/send", {
    method:'POST',
    headers:{ 'Authorization': token, 'Content-Type':'application/json' },
    body: JSON.stringify({target, message})
  });
  if(!res.ok){ throw new Error('HTTP '+res.status); }
}
document.getElementById('btnSetF').onclick = ()=>{
  const cur = readLocal(STORE.FONNTE_TOKEN_KEY) || FONNTE_TOKEN_EMBED;
  const t = prompt('Masukkan token Fonnte:', cur);
  if(t!==null){ saveLocal(STORE.FONNTE_TOKEN_KEY, t.trim()); paintDot(); log('üîê Token Fonnte diperbarui.'); }
};
document.getElementById('btnTest').onclick = async ()=>{
  try{
    await sendFonnte('6285218453131', 'Tes kirim dari NPA BOT ‚úÖ');
    log('‚úÖ Tes terkirim (ke admin).');
  }catch(e){ log('‚ùå Tes gagal: '+e.message); }
};
paintDot();

// ====== PESAN AI (humanized) ======
const footer = "\n\n#Terkirim dengan üíû dari NPA Smart System, Semangat Menembus Batas üöÄ";
const MSG = {
  motiv() {
    const arr = [
      "üåÖ Selamat pagi! Hari baru = peluang baru. Mulai kecil, mulai sekarang.",
      "üí´ Setiap langkah berarti. Konsisten hari ini, hasilnya ikut besok.",
      "üî• Rezeki tak pernah salah alamat. Tugas kita: bergerak & berproses.",
      "üöÄ Kebiasaan kecil yang benar hari ini = lompatan besar bulan depan.",
      "üí™ Fokus pada hal berdampak. Jaga ritme, jaga niat, jaga syukur."
    ];
    return arr[Math.floor(Math.random()*arr.length)] + footer;
  },
  fu10(){ return "üìä Statemen bonus sudah terbit! Yuk cek progres kerja cerdasmu. Evaluasi cepat, atur strategi, gas lagi!"+footer; },
  fu15(){ return "üè¶ Bonus sudah landing! Besar kecilnya tetap disyukuri üôè Yang belum, koordinasi dengan upline/leader ya. Kita atur langkah bareng."+footer; },
  fu18(){ return "ü§ù Momentum rekrut! Sapa prospek hangatmu hari ini. AI bantu follow-up, tapi sentuhan personal tetap kunci closing üîë"+footer; },
  fu29(){ return "‚è∞ Reminder penting! Segera bayar premi agar bonus bulan depan lancar. Butuh bantuan? Chat leader ya üí¨"+footer; }
};

// ====== BROADCAST UTILS ======
async function forEachLeader(sendFn){
  let leaders = [];
  try{ leaders = await fetchLeadersRaw(); }catch(_){}
  // fallback jika kosong: cache lokal (misal baru tambah)
  if(!leaders.length) leaders = STORE.leadersCache;
  if(!leaders.length){ log("‚ÑπÔ∏è Daftar leader kosong. Tambah dulu atau sinkron dari GitHub."); return; }

  for(const l of leaders){
    const target = (l.phone||"").replace(/\D/g,"");
    if(/^62\d{6,}$/.test(target)){
      try{ await sendFn(target); log(`‚úÖ ${target} terkirim`); }
      catch(e){ log(`‚ùå ${target} gagal: ${e.message}`); }
    }
  }
}

// Manual broadcast & followup now
document.getElementById('btnBc').onclick = ()=>{
  const text = MSG.motiv();
  log("üöÄ Broadcast manual dimulai‚Ä¶");
  forEachLeader(t => sendFonnte(t, text));
};
document.getElementById('btnFU').onclick = ()=>{
  const text = "[Manual Follow-Up] " + MSG.fu18(); // kamu bisa ganti cepat di sini
  log("üìû Follow-Up manual dimulai‚Ä¶");
  forEachLeader(t => sendFonnte(t, text));
};

// ====== AUTO SCHEDULER ======
setInterval(()=>{
  const n = nowWIB();
  UI.wibNow.textContent = `${tpad(n.getHours())}:${tpad(n.getMinutes())}:${tpad(n.getSeconds())} WIB`;

  // 06:00 motivasi
  if(UI.auto06.checked && n.getHours()===6 && n.getMinutes()===0 && n.getSeconds()<3){
    log("üåÖ 06:00: auto motivasi dimulai‚Ä¶");
    const text = MSG.motiv();
    forEachLeader(t => sendFonnte(t, text));
  }

  // tanggal 10/15/18/29 jam 08:00
  if(UI.autoFU.checked && n.getHours()===8 && n.getMinutes()===0 && n.getSeconds()<3){
    const d = n.getDate();
    let text="";
    if(d===10) text = MSG.fu10();
    else if(d===15) text = MSG.fu15();
    else if(d===18) text = MSG.fu18();
    else if(d===29) text = MSG.fu29();
    if(text){
      log(`üìÜ ${d}: auto follow-up dimulai‚Ä¶`);
      forEachLeader(t => sendFonnte(t, text));
    }
  }
}, 1000);
</script>
</body>
  </html>
