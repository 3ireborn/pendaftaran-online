<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NPA Smart System ‚Äî Admin Panel v4.7 Final</title>
  <style>
    :root{
      --brand:#0b3d91;
      --brand-2:#1a73e8;
      --bg:#f5f8ff;
      --card:#ffffff;
      --ink:#223;
      --muted:#667;
      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#dc2626;
      --ring:rgba(26,115,232,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:auto;padding:18px}
    .hero{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;border-radius:14px;padding:16px 18px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .hero h1{margin:0 0 6px;font-size:22px}
    .sub{opacity:.9;margin:0}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:14px}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;padding:14px 14px 12px;box-shadow:0 6px 18px rgba(11,61,145,.06);border:1px solid #e9eefc}
    h2{margin:0 0 8px;color:var(--brand);font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
    input,select{width:100%;padding:10px 12px;border:1px solid #d8e3ff;border-radius:10px;font:inherit;outline:none}
    input:focus,select:focus{border-color:var(--brand-2);box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eaf2ff;color:var(--brand)}
    .btn.ghost{background:#fff;color:var(--brand);border:1px solid #d8e3ff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;color:#445;text-align:left;padding:0 10px}
    .table td{background:#fff;border:1px solid #e9eefc;padding:10px;border-left-width:1px}
    .table tr td:first-child{border-radius:10px 0 0 10px}
    .table tr td:last-child{border-radius:0 10px 10px 0}
    .pill{display:inline-block;padding:4px 8px;border-radius:20px;font-size:12px;border:1px solid #e1e8ff;color:#345;background:#f7faff}
    .links a{display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border-radius:8px;border:1px solid #e3eaff;text-decoration:none;font-size:13px;color:var(--brand)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .foot{text-align:center;color:#556;margin-top:16px}
    .foot small{opacity:.9}
    .hint{background:#eef5ff;border:1px dashed #cfe2ff;padding:8px 10px;border-radius:10px;color:#345}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Admin Panel v4.7 ‚Äî NPA Smart System</h1>
      <p class="sub">Kontrol pusat: Leader, Link LP, Sinkron GitHub & BOT Monitor (auto motivasi 06:00 WIB).</p>
    </div>

    <div class="grid">
      <!-- Tambah Mitra -->
      <section class="card">
        <h2>‚ûï Tambah Mitra/Leader</h2>
        <div class="row">
          <div>
            <label>Nama Leader</label>
            <input id="in_name" placeholder="cth: Sugiarto Kurniawan">
          </div>
          <div>
            <label>No. WhatsApp (format 62‚Ä¶)</label>
            <input id="in_phone" placeholder="cth: 62852xxxxxxxx">
          </div>
        </div>
        <div class="flex" style="margin-top:10px">
          <button class="btn" id="btn_add">Tambah ke Daftar</button>
          <span class="muted" id="add_msg"></span>
        </div>
        <div class="hint" style="margin-top:10px">
          ID unik & kode akan dibuat otomatis (ID = inisial nama, Kode = nomor urut 3 digit).
        </div>
      </section>

      <!-- Sinkron GitHub -->
      <section class="card">
        <h2>‚òÅÔ∏è Sinkronisasi ke GitHub</h2>
        <div class="row">
          <div>
            <label>GitHub Owner / Org</label>
            <input id="gh_owner" placeholder="cth: 3ireborn">
          </div>
          <div>
            <label>Repository</label>
            <input id="gh_repo" placeholder="cth: pendaftaran-online">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Path leaders.json</label>
            <input id="gh_path" value="data/leaders.json">
          </div>
          <div>
            <label>Token (disimpan lokal)</label>
            <input id="gh_token" placeholder="ghp_xxx‚Ä¶">
          </div>
        </div>
        <div class="flex" style="margin-top:10px">
          <button class="btn" id="btn_save_gh">Simpan Token</button>
          <button class="btn secondary" id="btn_sync">Sinkron ke GitHub</button>
          <span class="muted" id="gh_msg"></span>
        </div>
        <div class="hint" style="margin-top:10px">
          Token hanya disimpan di perangkat ini (localStorage). Gunakan akun kamu sendiri.
        </div>
      </section>

      <!-- Daftar Leader -->
      <section class="card" style="grid-column:1/-1">
        <h2>üë• Daftar Leader & Link Otomatis</h2>
        <div class="flex" style="margin-bottom:8px">
          <span class="pill" id="stat_count">0 Leader</span>
          <span class="pill" id="stat_loaded">Memuat‚Ä¶</span>
        </div>

        <div class="hint" style="margin-bottom:10px">
          Link cepat: <strong>LP Master</strong> ‚Üí <code>/master-lp.html?leader=SLUG</code>,
          <strong>LP Hot</strong> ‚Üí <code>/replika-mini.html?leader=SLUG</code>,
          <strong>Pendaftaran</strong> ‚Üí <code>/index-v2.html?leader=SLUG</code>.
        </div>

        <table class="table" id="tbl">
          <thead>
            <tr>
              <th style="width:44%">Leader</th>
              <th style="width:20%">Kontak</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>

      <!-- AI Tools -->
      <section class="card">
        <h2>üß† AI Tools (Shortcut)</h2>
        <div class="links">
          <a target="_blank" href="./tools/npa-digital-assistant.html">NPA Digital Assistant</a>
          <a target="_blank" href="./tools/ai-fb-generator.html">FB Generator</a>
          <a target="_blank" href="./tools/ai-content-analyzer.html">Konten Analyzer</a>
          <a target="_blank" href="./tools/ai-seo-helper.html">SEO Helper</a>
          <a target="_blank" href="./tools/canva-designs.html">Desain Canva</a>
          <a target="_blank" href="./tools/followup179.html">FollowUp 1-7-9</a>
        </div>
        <p class="muted" style="margin-top:8px">Beberapa tools butuh file pendukung ‚Äî pastikan sudah tersedia agar tidak 404.</p>
      </section>

      <!-- Quick Help -->
      <section class="card">
        <h2>‚ÑπÔ∏è Bantuan Cepat</h2>
        <div class="hint">
          ‚Ä¢ Tambah Leader ‚Üí otomatis muncul link LP Master/Hot/Pendaftaran<br>
          ‚Ä¢ Klik ‚ÄúSinkron‚Äù untuk menyimpan ke <code>data/leaders.json</code> (butuh token).<br>
          ‚Ä¢ Panel BOT di bawah: klik <b>Set Token</b> (Fonnte) lalu Tes/Broadcast.
        </div>
      </section>
    </div>

    <div class="foot">
      <small>Powered by <b>NPA Smart System √ó 3iReborn</b> ‚Äî ‚ÄúKitaNganggur Punya Penghasilan‚Äù üöÄ</small>
    </div>
  </div>

  <script>
    // ==============
    // State & Utils
    // ==============
    const UI = {
      name: document.getElementById('in_name'),
      phone: document.getElementById('in_phone'),
      addBtn: document.getElementById('btn_add'),
      addMsg: document.getElementById('add_msg'),
      tbody: document.getElementById('tbody'),
      statCount: document.getElementById('stat_count'),
      statLoaded: document.getElementById('stat_loaded'),
      ghOwner: document.getElementById('gh_owner'),
      ghRepo: document.getElementById('gh_repo'),
      ghPath: document.getElementById('gh_path'),
      ghToken: document.getElementById('gh_token'),
      ghSave: document.getElementById('btn_save_gh'),
      ghSync: document.getElementById('btn_sync'),
      ghMsg: document.getElementById('gh_msg'),
    };

    const DEFAULT_OWNER = '3ireborn';
    const DEFAULT_REPO = 'pendaftaran-online';
    const DEFAULT_PATH = 'data/leaders.json';

    let leaders = [];
    let ghSha = null;

    function slugify(s) {
      return (s||'')
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g,'')
        .replace(/\s+/g,'-')
        .replace(/-+/g,'-')
        .trim();
    }
    function initials(name) {
      return (name||'')
        .trim()
        .split(/\s+/)
        .map(w=>w[0]||'')
        .join('')
        .slice(0,2)
        .toUpperCase();
    }
    function nextCode(list, idPrefix) {
      const same = list.filter(x=>x.id===idPrefix);
      const max = list.reduce((m,x)=>{
        if(x.id===idPrefix){
          const n = parseInt(x.code,10);
          return isNaN(n)?m:Math.max(m,n);
        }
        return m;
      }, 0);
      const num = Math.max(max, same.length) + 1;
      return String(num).padStart(3,'0');
    }

    // ==============
    // Render table
    // ==============
    function render() {
      UI.statCount.textContent = leaders.length + ' Leader';
      UI.tbody.innerHTML = '';
      const base = location.origin + location.pathname.replace(/\/[^\/]*$/, '/');

      leaders.forEach(l=>{
        const tr = document.createElement('tr');
        const lpMaster = base + 'master-lp.html?leader=' + encodeURIComponent(l.slug);
        const lpHot    = base + 'replika-mini.html?leader=' + encodeURIComponent(l.slug);
        const daftar   = base + 'index-v2.html?leader=' + encodeURIComponent(l.slug);
        tr.innerHTML = `
          <td>
            <div style="font-weight:700">${l.name}</div>
            <div class="muted">${l.id}${l.code} ‚Ä¢ slug: <code>${l.slug}</code></div>
          </td>
          <td>
            <div>WA: <a href="https://wa.me/${l.phone}" target="_blank">${l.phone}</a></div>
          </td>
          <td>
            <a class="pill" href="${lpMaster}" target="_blank">LP Master</a>
            <a class="pill" href="${lpHot}" target="_blank">LP Hot</a>
            <a class="pill" href="${daftar}" target="_blank">Pendaftaran</a>
          </td>
        `;
        UI.tbody.appendChild(tr);
      });
    }

    // ==============
    // Load leaders.json
    // ==============
    async function loadLeaders() {
      UI.statLoaded.textContent = 'Memuat‚Ä¶';
      const url = './data/leaders.json?v=' + Date.now();
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(Array.isArray(data)) leaders = data;
        UI.statLoaded.innerHTML = '<span class="ok">Siap ‚úî</span>';
      }catch(e){
        UI.statLoaded.innerHTML = '<span class="warn">Gagal muat, pakai cache lokal</span>';
        // fallback: jika ada cache lokal
        leaders = JSON.parse(localStorage.getItem('leaders_cache')||'[]');
      }
      render();
      // cache
      localStorage.setItem('leaders_cache', JSON.stringify(leaders));
    }

    // ==============
    // Add leader (local state)
    // ==============
    UI.addBtn.onclick = ()=>{
      const name = UI.name.value.trim();
      const phone = UI.phone.value.trim();
      if(!name || !phone){ UI.addMsg.textContent = 'Lengkapi nama & nomor WA.'; return; }

      const id = initials(name);
      const code = nextCode(leaders, id);
      const slug = slugify(name);

      // Cek duplikat slug/phone
      if(leaders.some(x=>x.slug===slug)){ UI.addMsg.textContent = 'Nama menghasilkan slug yang sudah dipakai.'; return; }
      if(leaders.some(x=>x.phone===phone)){ UI.addMsg.textContent = 'Nomor WA sudah terdaftar.'; return; }

      leaders.push({ id, code, name, phone, slug });
      UI.name.value=''; UI.phone.value=''; UI.addMsg.innerHTML = '<span class="ok">Ditambahkan ‚úî (belum tersinkron)</span>';
      render();
      localStorage.setItem('leaders_cache', JSON.stringify(leaders));
    };

    // ==============
    // GitHub helpers
    // ==============
    function saveGhLocal() {
      localStorage.setItem('gh_owner', UI.ghOwner.value.trim());
      localStorage.setItem('gh_repo',  UI.ghRepo.value.trim());
      localStorage.setItem('gh_path',  UI.ghPath.value.trim());
      localStorage.setItem('gh_token', UI.ghToken.value.trim());
      UI.ghMsg.innerHTML = '<span class="ok">Disimpan lokal ‚úî</span>';
    }
    function loadGhLocal() {
      UI.ghOwner.value = localStorage.getItem('gh_owner') || DEFAULT_OWNER;
      UI.ghRepo.value  = localStorage.getItem('gh_repo')  || DEFAULT_REPO;
      UI.ghPath.value  = localStorage.getItem('gh_path')  || DEFAULT_PATH;
      UI.ghToken.value = localStorage.getItem('gh_token') || '';
    }

    async function getGhFile(owner, repo, path, token){
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
        headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'}
      });
      if(!res.ok) throw new Error('GET '+res.status);
      return res.json();
    }
    async function putGhFile(owner, repo, path, token, content, sha, message){
      const body = {
        message,
        content: btoa(unescape(encodeURIComponent(content))),
        sha
      };
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
        method:'PUT',
        headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'},
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error('PUT '+res.status);
      return res.json();
    }

    UI.ghSave.onclick = saveGhLocal;

    UI.ghSync.onclick = async ()=>{
      UI.ghMsg.textContent = 'Sinkronisasi‚Ä¶';
      const owner = UI.ghOwner.value.trim() || DEFAULT_OWNER;
      const repo  = UI.ghRepo.value.trim()  || DEFAULT_REPO;
      const path  = UI.ghPath.value.trim()  || DEFAULT_PATH;
      const token = UI.ghToken.value.trim();
      if(!token){ UI.ghMsg.innerHTML = '<span class="warn">Isi token dulu</span>'; return; }

      try{
        const cur = await getGhFile(owner,repo,path,token);
        ghSha = cur.sha;
      }catch(e){
        ghSha = null; // file mungkin belum ada
      }

      try{
        const json = JSON.stringify(leaders, null, 2);
        const msg  = 'chore(admin): sync leaders.json via Admin v4.7 Final';
        await putGhFile(owner,repo,path,token,json,ghSha||undefined,msg);
        UI.ghMsg.innerHTML = '<span class="ok">Sinkron sukses ‚úî</span>';
      }catch(e){
        UI.ghMsg.innerHTML = '<span class="err">Gagal sinkron: '+e.message+'</span>';
      }
    };

    // boot
    loadGhLocal();
    loadLeaders();
  </script>

  <!-- üåê NPA BOT Monitor Integration ‚Äî INLINE (FULL) -->
  <style>
    #npa-bot-monitor{position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #npa-bot-monitor .npa-bar{background:#0b3d91;color:#fff;border-radius:12px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(0,0,0,.15)}
    #npa-bot-monitor .left{display:flex;gap:8px;align-items:center}
    #npa-bot-monitor .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #npa-bot-monitor .btn{background:#fff;color:#0b3d91;border:0;padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    #npa-bot-monitor .btn.alt{background:#eaf2ff}
    #npa-bot-monitor .switch{display:flex;gap:6px;align-items:center;color:#fff}
    #npa-bot-monitor .switch input{accent-color:#18a957;width:18px;height:18px}
    #npa-bot-monitor .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#bbb}
    #npa-bot-monitor .dot.ok{background:#1ec28b;box-shadow:0 0 0 3px rgba(30,194,139,.25)}
    #npa-bot-monitor .dot.warn{background:#ffb020;box-shadow:0 0 0 3px rgba(255,176,32,.25)}
    #npa-bot-monitor .npa-log{margin-top:8px;background:#f7faff;border:1px solid #e2eeff;color:#123;border-radius:10px;max-height:35vh;overflow:auto;padding:8px 10px;font-size:.92em}
  </style>

  <script defer>
    // =======================
    // ü§ñ NPA Smart BOT Monitor ‚Äî Inline Version
    // =======================
    const NPA_MON = {
      ownerName: "Sugiarto Kurniawan",
      ownerPhone: "6285218453131",
      baseUrl: "https://api.fonnte.com/send",
      tz: "Asia/Jakarta",
      leaders: [
        "6285218453131","6285932684440","62881011823140","6281388675615",
        "6282199558169","6281327498929","6281285949074","966563414575",
        "6586210326","6281236544821","6282252161911","6281236781273","6288293744431"
      ],
      autoHour: 6,
      autoMinute: 0,
    };
    const MOTIVATIONS = [
      "üí´ Setiap hari adalah peluang baru untuk menjemput rezeki. Tetap semangat üí™ #Terkirim dengan üíû dari NPA Smart System üöÄ",
      "üåÖ Jangan takut gagal, takutlah kalau kamu berhenti mencoba. #NPA #3iReborn üöÄ",
      "üî• Rezeki tidak akan salah alamat, yang penting terus bergerak dengan niat baik üíº #SmartSystem #3iNetworks",
      "üí™ Jadikan hari ini luar biasa dengan semangat yang tak biasa! #Terkirim dari NPA Smart System üöÄ",
      "üöÄ Kesuksesan adalah hasil dari kebiasaan kecil yang dilakukan setiap hari. Yuk lanjutkan perjuanganmu! #3iReborn"
    ];
    function getFonnteToken(){return localStorage.getItem("fonnte_token")||""}
    function setFonnteToken(tok){localStorage.setItem("fonnte_token",tok);paintBotDot()}
    function paintBotDot(){const d=document.getElementById("npa-status-dot");if(d)d.className="dot "+(getFonnteToken()?"ok":"warn")}
    function addBotLog(line){
      const box=document.getElementById("npa-log");if(!box)return;
      const t=new Date().toLocaleTimeString("id-ID",{timeZone:NPA_MON.tz,hour12:false});
      const p=document.createElement("div");p.textContent=`[${t}] ${line}`;box.prepend(p);
    }
    async function sendViaFonnte(target,message){
      const token=getFonnteToken(); if(!token)throw new Error("Token kosong. Set token dulu.");
      const res=await fetch(NPA_MON.baseUrl,{
        method:"POST",
        headers:{ "Authorization":token, "Content-Type":"application/json" },
        body: JSON.stringify({ target, message })
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      return true;
    }
    async function broadcastMotivation(msg){
      for(const phone of NPA_MON.leaders){
        try{
          await sendViaFonnte(phone, msg+"\n\nSmart Auto Broadcast by 3iReborn || NPA Team üöÄ");
          addBotLog("‚úÖ "+phone+" terkirim");
        }catch(e){
          addBotLog("‚ùå "+phone+" gagal: "+e.message);
        }
      }
    }
    let autoOn=true;
    function tickAuto(){
      if(!autoOn) return;
      const wib=new Date(new Date().toLocaleString("en-US",{timeZone:NPA_MON.tz}));
      if(wib.getHours()===NPA_MON.autoHour && wib.getMinutes()===NPA_MON.autoMinute){
        const msg=MOTIVATIONS[Math.floor(Math.random()*MOTIVATIONS.length)];
        addBotLog("üöÄ Auto 06:00: broadcast dimulai");
        broadcastMotivation(msg);
        setTimeout(()=>{},61000);
      }
    }
    setInterval(tickAuto,15000);
    function createBotUI(){
      const w=document.createElement("div");
      w.id="npa-bot-monitor";
      w.innerHTML=`
        <div class="npa-bar">
          <div class="left"><span class="dot" id="npa-status-dot"></span><b>NPA BOT</b><span class="muted">‚Ä¢ WIB</span></div>
          <div class="right">
            <button id="npa-btn-token" class="btn alt">Set Token</button>
            <button id="npa-btn-test" class="btn">Tes</button>
            <button id="npa-btn-bc" class="btn">Broadcast</button>
            <label class="switch"><input type="checkbox" id="npa-auto" checked><span>Auto 06:00</span></label>
          </div>
        </div>
          <div class="left"><span class="dot" id="npa-status-dot"></span><b>NPA BOT</b><span class="muted">‚Ä¢ WIB</span></div>
          <div class="right">
            <button id="npa-btn-token" class="btn alt">Set Token</button>
            <button id="npa-btn-test" class="btn">Tes</button>
            <button id="npa-btn-bc" class="btn">Broadcast</button>
            <label class="switch"><input type="checkbox" id="npa-auto" checked><span>Auto 06:00</span></label>
          </div>
        </div>
        <div class="npa-log" id="npa-log"></div>
      `;   // üëà ini penting! tutup string-nya di sini
      document.body.appendChild(w);

      document.getElementById("npa-btn-token").onclick=()=>{
        const cur=getFonnteToken();
        const t=prompt("Masukkan token Fonnte:",cur||"");
        if(t!==null){ setFonnteToken(t.trim()); addBotLog("üîê Token diperbarui."); }
      };
      document.getElementById("npa-btn-test").onclick=async()=>{
        try{
          await sendViaFonnte(NPA_MON.ownerPhone,"Tes kirim dari NPA BOT Monitor ‚úÖ");
          addBotLog("‚úÖ Tes terkirim");
        }catch(e){ addBotLog("‚ùå Tes gagal: "+e.message); }
      };
      document.getElementById("npa-btn-bc").onclick=()=>{
        const msg=MOTIVATIONS[Math.floor(Math.random()*MOTIVATIONS.length)];
        addBotLog("üöÄ Broadcast manual dimulai");
        broadcastMotivation(msg);
      };
      document.getElementById("npa-auto").onchange=e=>{
        autoOn=e.target.checked; addBotLog("‚öôÔ∏è Auto "+(autoOn?"ON":"OFF"));
      };
      paintBotDot();
    }
    document.addEventListener("DOMContentLoaded", createBotUI);
  </script>
</body>
</html>
