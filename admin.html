<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel - NPA Cloud Sync</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:'Poppins',sans-serif;background:#f8fafc;color:#1e293b;margin:0;padding:20px}
.container{max-width:800px;margin:auto;background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.1);}
h1{text-align:center;color:#0b3d91}
input,button,select{width:100%;padding:12px;margin:8px 0;border:1px solid #cbd5e1;border-radius:8px;font-size:15px}
button{background:#0b3d91;color:#fff;font-weight:600;cursor:pointer;border:none}
button:hover{filter:brightness(.95)}
.leader-list{margin-top:20px}
.leader-item{background:#f1f5f9;padding:10px;border-radius:8px;margin-bottom:8px}
footer{text-align:center;margin-top:25px;color:#64748b;font-size:13px}
.role{margin-bottom:15px;text-align:center;font-weight:600;color:#d4380d}
</style>
</head>
<body>
<div class="container">
  <h1>üåê NPA Cloud Sync Admin</h1>
  <div class="role" id="role">Belum login</div>

  <div id="loginPanel">
    <select id="loginRole">
      <option value="admin">Admin</option>
      <option value="leader">Leader</option>
    </select>
    <input type="text" id="loginCode" placeholder="Kode (misal SK001)">
    <input type="password" id="loginPass" placeholder="Password (Admin only)">
    <button onclick="login()">LOGIN</button>
  </div>

  <div id="adminPanel" style="display:none">
    <h2>Tambah Leader Baru</h2>
    <input type="text" id="name" placeholder="Nama Leader">
    <input type="tel" id="phone" placeholder="No WA (628...)">
    <button onclick="addLeader()">+ Tambah Leader</button>
    <div class="leader-list" id="list"></div>
    <button style="background:#10b981" onclick="syncCloud()">‚òÅÔ∏è Upload ke Cloud</button>
  </div>

  <div id="leaderPanel" style="display:none">
    <h2>Tambah Mitra Baru</h2>
    <input type="text" id="mitraName" placeholder="Nama Mitra">
    <input type="tel" id="mitraPhone" placeholder="No WA Mitra (628...)">
    <button onclick="addMitra()">+ Tambah Mitra Saya</button>
    <div id="mitraList"></div>
  </div>
</div>

<footer>¬© 2025 NPA Digital System ‚Äî Semi Admin Cloud Sync</footer>

<script>
const GITHUB_REPO = "3ireborn/pendaftaran-online";
const DATA_PATH = "data/leaders.json";
const ADMIN_PASS = "npaadmin2025"; // Ganti password admin di sini

let leaders = [];
let currentRole = "";
let currentLeader = null;

// === LOGIN LOGIC ===
function login(){
  const role = document.getElementById('loginRole').value;
  const code = document.getElementById('loginCode').value.trim().toUpperCase();
  const pass = document.getElementById('loginPass').value;

  fetch(`https://raw.githubusercontent.com/${GITHUB_REPO}/main/${DATA_PATH}`)
    .then(r=>r.json()).then(data=>{
      leaders = data;
      if(role==="admin"){
        if(pass!==ADMIN_PASS) return alert("Password salah, beb üòÖ");
        currentRole="admin";
        document.getElementById('role').textContent="Mode: ADMIN PUSAT";
        document.getElementById('loginPanel').style.display="none";
        document.getElementById('adminPanel').style.display="block";
        renderLeaders();
      } else {
        const found = leaders.find(l=>l.code===code);
        if(!found) return alert("Kode Leader tidak ditemukan.");
        currentRole="leader";
        currentLeader=found;
        document.getElementById('role').textContent=`Mode: LEADER (${found.name})`;
        document.getElementById('loginPanel').style.display="none";
        document.getElementById('leaderPanel').style.display="block";
        loadMitra(found.code);
      }
    }).catch(e=>alert("Gagal memuat data dari cloud."));
}

// === ADMIN FUNCTIONS ===
function renderLeaders(){
  const list = document.getElementById('list');
  list.innerHTML = leaders.map(l=>`<div class='leader-item'><b>${l.code}</b> ‚Äî ${l.name} (${l.phone})</div>`).join('');
}

function addLeader(){
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  if(!name||!phone)return alert("Isi nama & WA dulu beb!");
  const code="ID"+String(leaders.length+1).padStart(3,'0');
  const slug=name.toLowerCase().replace(/[^a-z0-9]/g,'');
  leaders.push({code,name,phone,slug});
  localStorage.setItem('leaders',JSON.stringify(leaders));
  renderLeaders();
  document.getElementById('name').value='';
  document.getElementById('phone').value='';
  alert("Leader berhasil ditambah lokal!");
}

async function syncCloud(){
  const token = prompt("Masukkan GitHub Personal Access Token kamu:");
  if(!token)return alert("Token dibutuhkan untuk update cloud.");
  const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_PATH}`);
  const json = await response.json();
  const sha = json.sha;
  const update = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_PATH}`,{
    method:"PUT",
    headers:{
      "Authorization":`token ${token}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:"Update data leaders via NPA Admin Panel",
      content:btoa(unescape(encodeURIComponent(JSON.stringify(leaders,null,2)))),
      sha:sha
    })
  });
  if(update.ok) alert("‚òÅÔ∏è Data berhasil diupload ke Cloud!");
  else alert("Gagal upload ke Cloud üò¢");
}

// === LEADER FUNCTIONS ===
function addMitra(){
  const n=document.getElementById('mitraName').value.trim();
  const p=document.getElementById('mitraPhone').value.trim();
  if(!n||!p)return alert("Isi nama & WA mitra dulu beb!");
  const key=`mitra_${currentLeader.code}`;
  const existing=JSON.parse(localStorage.getItem(key)||'[]');
  existing.push({nama:n,wa:p});
  localStorage.setItem(key,JSON.stringify(existing));
  document.getElementById('mitraName').value='';
  document.getElementById('mitraPhone').value='';
  loadMitra(currentLeader.code);
}

function loadMitra(code){
  const key=`mitra_${code}`;
  const list=JSON.parse(localStorage.getItem(key)||'[]');
  const div=document.getElementById('mitraList');
  div.innerHTML=list.length?list.map(m=>`<div class='leader-item'>${m.nama} - ${m.wa}</div>`).join(''):"<i>Belum ada mitra.</i>";
}
</script>
</body>
</html>
