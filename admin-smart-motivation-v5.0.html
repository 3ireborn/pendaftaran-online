<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NPA Motivation v5.0 ‚Äî AI Weekly Refresh</title>

  <!-- PWA optional -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b3d91">
  <link rel="icon" href="./asset/npa-icon-512.png" type="image/png">

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#9aa7bd; --text:#e6edff; --pri:#4f8cff; --good:#3ecf8e; --warn:#ffd166;
      --border:#1d2540;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,sans-serif}
    header{padding:18px 16px;background:linear-gradient(180deg,#0d1b3a 0%, #0b1220 100%);border-bottom:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:22px;display:flex;gap:10px;align-items:center}
    .sub{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin:16px 0}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .title{font-weight:700;margin:0 0 10px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    select,button,textarea{border-radius:10px;border:1px solid var(--border);background:#0b1428;color:var(--text)}
    select,button{padding:10px 14px}
    button{background:var(--pri);border-color:#2a59c7;cursor:pointer}
    button.ghost{background:#0b1428}
    button.good{background:var(--good);color:#00280f;border-color:#1e7e55}
    textarea{width:100%;min-height:120px;padding:12px;resize:vertical}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0c1730;color:var(--muted);font-size:12px}
    .msg{background:#0c1730;border:1px dashed #234; padding:12px;border-radius:10px;margin-top:10px}
    .list .item{display:flex;justify-content:space-between;align-items:center;background:#0c1730;border:1px solid var(--border);padding:10px 12px;border-radius:10px;margin:8px 0}
    .item .status{font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1428}
    .pill.good{border-color:#215f44;background:#05291a;color:#7af0b7}
    .pill.run{border-color:#2e3d67;background:#0b1b3d;color:#a6b8ff}
    .footer{text-align:center;color:var(--muted);font-size:12px;margin:16px 0}
    .sep{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üß† NPA Motivation v5.0 <span class="tag">AI Weekly Refresh ‚Ä¢ Dark</span></h1>
    <div class="sub">Smart Auto Broadcast by 3IReborn || NPA Team ‚Ä¢ Zona: <b>WIB (Asia/Jakarta)</b></div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- LEFT: Composer -->
    <section class="card">
      <div class="title">‚úçÔ∏è Composer & AI Refresh</div>
      <div class="row">
        <span class="tag" id="weekTag">Minggu ke-‚Ä¶</span>
        <span class="tag" id="todayTag">Hari: ‚Ä¶</span>
        <span class="tag" id="timeTag">Waktu: ‚Ä¶</span>
      </div>

      <div class="msg" id="aiStatus">Status AI: Otomatis refresh setiap Minggu 23:59 WIB (mock AI di sisi client). Kamu bisa paksa refresh sekarang.</div>

      <div class="row" style="margin-top:10px">
        <button class="ghost" id="btnAiRefresh">ü§ñ AI Refresh Minggu Ini</button>
        <button class="ghost" id="btnLoadToday">üìÖ Muat Pesan Hari Ini</button>
        <select id="manualHour">
          <option>06:00</option><option>12:00</option><option>17:00</option><option>21:00</option>
        </select>
      </div>

      <div class="sep"></div>
      <label class="muted">Ketik motivasi manual (opsional, akan menimpa AI):</label>
      <textarea id="manualText" placeholder="Tulis motivasi manual di sini bila ingin mengganti pesan AI untuk hari ini‚Ä¶"></textarea>

      <div class="msg" id="preview">Preview pesan akan tampil di sini‚Ä¶</div>

      <div class="row" style="margin-top:10px">
        <button class="good" id="btnSendAll">üöÄ Kirim ke Semua Leader</button>
        <button class="ghost" id="btnShowList">üìã Tampilkan Daftar Leader</button>
      </div>

      <div class="footer">
        #Terkirim dengan üíû dari NPA Smart System, Semangat Menembus Batas üöÄ
      </div>
    </section>

    <!-- RIGHT: Leaders & Progress -->
    <section class="card">
      <div class="title">üë• Daftar Leader & Progress</div>
      <div class="row">
        <span class="pill" id="autoInfo">Auto 06:00 WIB: AKTIF</span>
        <span class="pill run" id="progressInfo">Progress: -</span>
      </div>

      <div class="msg muted" style="margin-top:10px">
        ‚Ä¢ Auto kirim 06:00 WIB harian (WIB locked).<br/>
        ‚Ä¢ Manual broadcast bisa kapan saja. Delay antar pesan ¬±1.2s (aman).<br/>
        ‚Ä¢ Warna hijau üü¢ menandakan tab WA sudah dibuka untuk leader tersebut.
      </div>

      <div id="leaders" class="list" style="margin-top:10px"></div>
    </section>
  </div>

  <div class="footer">¬© NPA ‚Ä¢ 3IReborn Smart System</div>
</main>

<script>
/* ===== Time helpers (WIB locked) ===== */
const toWIB = (d=new Date()) => new Date(d.toLocaleString('en-US',{timeZone:'Asia/Jakarta'}));
const hariID = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
const footerSig = "\n\n#Terkirim dengan üíû dari NPA Smart System, Semangat Menembus Batas üöÄ";
const LEADERS_URL = "./data/leaders.json";

/* ===== UI refs ===== */
const weekTag = document.getElementById('weekTag');
const todayTag = document.getElementById('todayTag');
const timeTag = document.getElementById('timeTag');
const aiStatus = document.getElementById('aiStatus');
const preview = document.getElementById('preview');
const manualText = document.getElementById('manualText');
const manualHour = document.getElementById('manualHour');
const leadersDiv = document.getElementById('leaders');
const progressInfo = document.getElementById('progressInfo');
const btnAiRefresh = document.getElementById('btnAiRefresh');
const btnLoadToday = document.getElementById('btnLoadToday');
const btnSendAll = document.getElementById('btnSendAll');
const btnShowList = document.getElementById('btnShowList');

/* ===== State ===== */
let leaders = [];
let weekCache = null; // {week: 2025-37, messages:{Senin:"...", ...}}
let sending = false;
let sentCount = 0;

/* ===== Mock AI sources (in-HTML). 
   Jika tersedia, file ./data/motivation-template.json akan dipakai sebagai sumber tema tambahan. */
const seedOpeners = [
  "Mulai kecil, mulai sekarang.",
  "Langkah pendek hari ini, lompatan besar esok.",
  "Konsistensi mengalahkan intensitas.",
  "Fokus pada kualitas ikhtiar, bukan sekadar hasil.",
  "Allah melihat prosesmu, bukan cuma puncaknya."
];
const seedCores = [
  "Bangun ritme, bukan sekadar mood.",
  "Kalem eksekusi, tajam evaluasi.",
  "Syukuri yang ada, perjuangkan yang belum.",
  "Kesibukan tak sama dengan kemajuan‚Äîpilih yang berdampak.",
  "Sedikit tapi tuntas, ulangi tiap hari."
];
const seedClosers = [
  "Semangat‚Äîrejeki menyukai yang tekun.",
  "Naikkan standar pelan-pelan.",
  "Jaga adab, rapikan ikhtiar.",
  "Jalani proses, cintai perjalanan.",
  "Istiqamah itu superpower."
];

/* ===== Helpers ===== */
function getISOWeek(d){
  const date = toWIB(d);
  const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNr = (target.getUTCDay()+6)%7;
  target.setUTCDate(target.getUTCDate()-dayNr+3);
  const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
  const week = 1+Math.round(((target-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);
  return `${target.getUTCFullYear()}-${String(week).padStart(2,'0')}`;
}

function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function buildMessageFor(day){
  // Susun kalimat dengan nuansa berbeda tiap hari
  const base =
    (day==="Senin") ? "Senin itu tombol START. " :
    (day==="Jumat") ? "Jumat penuh berkah. " :
    (day==="Minggu") ? "Minggu, isi ulang hati & strategi. " :
    `${day}‚Äîlanjutkan ritmemu. `;
  return `${base}${randPick(seedOpeners)} ${randPick(seedCores)} ${randPick(seedClosers)} üíô`;
}

function renderInfo(){
  const now = toWIB();
  const week = getISOWeek(now);
  weekTag.textContent = `Minggu ke: ${week}`;
  todayTag.textContent = `Hari: ${hariID[now.getDay()]}`;
  timeTag.textContent  = `Waktu: ${now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})} WIB`;
}

/* ===== Cache AI weekly ===== */
function loadCache(){
  try{
    const raw = localStorage.getItem('npa_ai_week_cache');
    return raw ? JSON.parse(raw) : null;
  }catch(_){ return null; }
}
function saveCache(cache){
  localStorage.setItem('npa_ai_week_cache', JSON.stringify(cache));
}

/* ===== AI refresh (mock) ===== */
async function aiRefresh(force=false){
  const now = toWIB();
  const week = getISOWeek(now);
  const cache = loadCache();
  if(cache && cache.week===week && !force){
    weekCache = cache;
    aiStatus.textContent = `Status AI: memakai cache minggu ${week}.`;
    return;
  }
  // (opsional) gabungkan template eksternal bila ada
  try{
    const res = await fetch('./data/motivation-template.json', {cache:'no-store'});
    if(res.ok){
      const ext = await res.json();
      if(Array.isArray(ext.openers)) seedOpeners.push(...ext.openers);
      if(Array.isArray(ext.cores))   seedCores.push(...ext.cores);
      if(Array.isArray(ext.closers)) seedClosers.push(...ext.closers);
    }
  }catch(_){}

  const messages = {};
  ["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu","Minggu"].forEach(d=>{
    messages[d] = buildMessageFor(d);
  });
  weekCache = {week, messages};
  saveCache(weekCache);
  aiStatus.textContent = `Status AI: generate ulang pesan minggu ${week} (client-side mock).`;
}

/* ===== Compose Hari Ini ===== */
function composeToday(){
  const now = toWIB();
  const day = hariID[now.getDay()];
  const manual = manualText.value.trim();
  const text = (manual || (weekCache?.messages?.[day] ?? buildMessageFor(day))) + footerSig;
  preview.textContent = text;
  return text;
}

/* ===== Leaders ===== */
async function loadLeaders(){
  try{
    const res = await fetch(LEADERS_URL + '?v=' + Date.now());
    leaders = await res.json();
  }catch(e){
    leaders = [];
    alert('Gagal memuat data leader.');
  }
  renderLeaders(false);
}

function renderLeaders(resetSent){
  leadersDiv.innerHTML = '';
  sentCount = 0;
  leaders.forEach((L, i)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.index = i;
    row.innerHTML = `<div>${L.code ? L.code+' ' : ''}${L.name}</div><div class="status pill">Menunggu‚Ä¶</div>`;
    if(resetSent){ row.querySelector('.status').textContent = 'Menunggu‚Ä¶'; row.classList.remove('sentRow'); }
    leadersDiv.appendChild(row);
  });
  progressInfo.textContent = `Progress: 0 / ${leaders.length}`;
}

function markSent(i){
  const row = leadersDiv.querySelector(`.item[data-index="${i}"]`);
  if(!row) return;
  row.classList.add('sentRow');
  const s = row.querySelector('.status');
  s.textContent = 'Terkirim üü¢';
  s.classList.add('good');
  sentCount++;
  progressInfo.textContent = `Progress: ${sentCount} / ${leaders.length}`;
}

/* ===== Broadcast ===== */
function waLink(phone, text){
  const p = (phone+'').replace(/[^\d]/g,'');
  return `https://wa.me/${p}?text=${encodeURIComponent(text)}`;
}

function sendAll(text){
  if(!leaders.length){ alert('Daftar leader kosong.'); return; }
  if(!text){ alert('Pesan kosong. Klik "Muat Pesan Hari Ini" atau tulis manual.'); return; }
  if(sending) return;

  sending = true;
  let i=0;
  const tick = ()=>{
    if(i>=leaders.length){ sending=false; return; }
    const L = leaders[i];
    // Buka WA per-leader
    window.open(waLink(L.phone, text), '_blank');
    markSent(i);
    i++;
    setTimeout(tick, 1200); // delay aman
  };
  tick();
}

/* ===== Auto Schedulers ===== */
// 1) Auto broadcast 06:00 WIB harian
function autoDailyLoop(){
  const now = toWIB();
  const hhmm = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
  // bandingkan dengan jam dropdown (default 06:00 pada UI sebelah kiri)
  const target = "06:00";
  if(hhmm===target && now.getSeconds()<3){
    const text = composeToday();
    // Auto kirim: bisa aktifkan bila ingin full otomatis tanpa klik:
    // sendAll(text);
  }
}
setInterval(autoDailyLoop, 1000);

// 2) Auto AI refresh tiap Minggu 23:59 WIB
function autoWeeklyRefreshLoop(){
  const now = toWIB();
  const isSunday = (now.getDay()===0);
  const hh = now.getHours(), mm = now.getMinutes();
  if(isSunday && hh===23 && mm===59 && now.getSeconds()<3){
    aiRefresh(true).then(()=> composeToday());
  }
}
setInterval(autoWeeklyRefreshLoop, 1000);

/* ===== Init ===== */
function initTickers(){
  setInterval(()=>{ renderInfo(); }, 1000);
}

(async function boot(){
  renderInfo();
  await aiRefresh(false);
  composeToday();
  await loadLeaders();
  initTickers();
})();

/* ===== Events ===== */
btnAiRefresh.addEventListener('click', async ()=>{
  await aiRefresh(true);
  composeToday();
});
btnLoadToday.addEventListener('click', ()=> composeToday());
btnSendAll.addEventListener('click', ()=> {
  const text = composeToday();
  renderLeaders(true);
  sendAll(text);
});
btnShowList.addEventListener('click', ()=> {
  leadersDiv.style.display = leadersDiv.style.display==='none' ? 'block' : 'none';
});
</script>
</body>
  </html>
