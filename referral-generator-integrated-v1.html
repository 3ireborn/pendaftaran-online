<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Pusat â€” Referral Generator (Integrated)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#07102a; --card:#071b2e; --accent:#ffd24d; --muted:#9fb0c6; --white:#fff;
  }
  body{font-family:Poppins,Arial; background:#021127; color:var(--white); margin:0; padding:24px; -webkit-font-smoothing:antialiased}
  .wrap{max-width:880px;margin:0 auto}
  h1{margin:0 0 16px;font-size:22px;color:var(--accent)}
  .card{background:linear-gradient(180deg,#08162a 0,#062034 100%); padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.5); border:1px solid rgba(255,210,77,.06)}
  label{display:block;font-size:13px;color:var(--muted); margin-bottom:6px}
  input[type=text], input[type=file]{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.03); color:var(--white); box-sizing:border-box}
  .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
  .btn{display:inline-block;padding:12px 14px;border-radius:10px;background:linear-gradient(90deg,#2ecc71,#27ae60);color:#fff;text-decoration:none;border:none;cursor:pointer}
  .btn.secondary{background:linear-gradient(90deg,#ff6b6b,#ff3b3b)}
  .btn.yellow{background:linear-gradient(90deg,#ffd24d,#ffc107); color:#081b2e}
  .small{font-size:13px;color:var(--muted)}
  .list{margin-top:18px}
  table{width:100%; border-collapse:collapse; margin-top:8px; font-size:14px}
  th,td{padding:8px 6px; text-align:left; border-bottom:1px dashed rgba(255,255,255,.03)}
  .preview{margin-top:18px;padding:12px;background:rgba(255,255,255,.02); border-radius:10px}
  .social-card{width:320px; background:#0b2030; padding:18px;border-radius:16px;color:#fff; text-align:center}
  .avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:6px solid var(--accent);margin:0 auto 12px}
  .qr{width:200px;height:200px;background:#fff;padding:8px;border-radius:16px;display:inline-block}
  .note{font-size:13px;color:var(--muted);margin-top:10px}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  @media(max-width:700px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin Pusat â€” Referral Generator (Integrated)</h1>

  <div class="card">
    <div>
      <label>Nama Leader</label>
      <input id="inName" type="text" placeholder="cth: Sugiarto Kurniawan" />
    </div>

    <div style="margin-top:12px;">
      <label>Nomor WA Leader (format 62... )</label>
      <input id="inPhone" type="text" placeholder="62822..." />
    </div>

    <div style="margin-top:12px;">
      <label>Slug (opsional â€” kosongkan untuk auto)</label>
      <input id="inSlug" type="text" placeholder="cth: sugiarto-ksm" />
    </div>

    <div style="margin-top:12px;">
      <label>Foto Leader (opsional, square atau 4:5)</label>
      <input id="inPhoto" type="file" accept="image/*" />
      <div class="note">Foto disimpan di browser (localStorage) sebagai data image. Jika mau publik, export leaders.json lalu upload ke repo /data/leaders.json</div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnAdd" class="btn">Tambah / Simpan Leader</button>
      <button id="btnExport" class="btn yellow">Export leaders.json</button>
      <button id="btnClear" class="btn secondary">Clear localStorage</button>
    </div>

    <div class="list">
      <h3 style="margin-top:18px">Daftar Leader</h3>
      <div id="tableWrap"></div>
    </div>

    <div style="margin-top:18px">
      <small class="small">Gunakan tombol "Copy Links" untuk menyalin 3 link utama (LP Master, LP Hot, Pendaftaran). Setelah export, upload file <code>/data/leaders.json</code> ke repo agar LP lain bisa fetch leader secara global.</small>
    </div>

  </div>

  <div style="height:16px"></div>

  <div class="card">
    <h3>Preview / Generator</h3>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <select id="selectLeader" style="padding:10px;border-radius:8px;background:rgba(255,255,255,.03);color:#fff;border:1px solid rgba(255,255,255,.04)">
        <option value="">-- pilih leader --</option>
      </select>
      <button id="btnCopyLinks" class="btn">Copy Links</button>
      <button id="btnGenQR" class="btn yellow">Generate QR & Preview</button>
      <button id="btnDownloadCard" class="btn secondary">Download Social Card (PNG)</button>
      <button id="btnGenRedirect" class="btn">Download LP Redirect (HTML)</button>
    </div>

    <div id="preview" class="preview" style="display:none">
      <div id="cardWrap" class="social-card">
        <img id="pvAvatar" class="avatar" src="" alt="avatar" />
        <div id="pvName" style="font-weight:700;font-size:18px;color:var(--accent)">nama</div>
        <div style="margin:10px 0;color:#b1c7d4">Scan QR untuk membuka link referral</div>
        <div id="pvQr" class="qr"><img id="pvQrImg" style="width:100%;height:100%;object-fit:contain" src="" /></div>
      </div>
      <div class="note">Jika ingin live (semua orang bisa lihat): export leaders.json lalu upload ke repo `/data/leaders.json`</div>
    </div>

  </div>

</div>

<!-- html2canvas CDN -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ---------- helper ---------- */
const LS_KEY = 'ir_leaders_v1';
function slugify(s){ return s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}
function loadLeaders(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]') }catch(e){return []} }
function saveLeaders(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)) }
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
function downloadFile(filename, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
function copyText(t){ navigator.clipboard && navigator.clipboard.writeText(t).then(()=>toast('Tersalin')) }

/* ---------- UI refs ---------- */
const inName=document.getElementById('inName');
const inPhone=document.getElementById('inPhone');
const inSlug=document.getElementById('inSlug');
const inPhoto=document.getElementById('inPhoto');
const btnAdd=document.getElementById('btnAdd');
const btnExport=document.getElementById('btnExport');
const btnClear=document.getElementById('btnClear');
const tableWrap=document.getElementById('tableWrap');
const selectLeader=document.getElementById('selectLeader');
const btnCopyLinks=document.getElementById('btnCopyLinks');
const btnGenQR=document.getElementById('btnGenQR');
const preview=document.getElementById('preview');
const pvAvatar=document.getElementById('pvAvatar');
const pvName=document.getElementById('pvName');
const pvQrImg=document.getElementById('pvQrImg');
const btnDownloadCard=document.getElementById('btnDownloadCard');
const btnGenRedirect=document.getElementById('btnGenRedirect');

/* ---------- render ---------- */
function renderTable(){
  const arr = loadLeaders();
  // render select
  selectLeader.innerHTML = '<option value="">-- pilih leader --</option>';
  arr.forEach((l,i)=>{
    const opt=document.createElement('option'); opt.value=i; opt.textContent = l.name + ' â€” ' + l.phone; selectLeader.appendChild(opt);
  });

  if(!arr.length){ tableWrap.innerHTML='<div class="small">Belum ada leader. Tambah leader dulu.</div>'; return; }

  let html = '<table><thead><tr><th>No</th><th>Nama</th><th>WA</th><th>Slug</th><th>Aksi</th></tr></thead><tbody>';
  arr.forEach((l,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td>${l.name}</td>
      <td>${l.phone}</td>
      <td>${l.slug||''}</td>
      <td>
        <button onclick="editLeader(${i})" style="padding:6px 8px;border-radius:6px;margin-right:6px">Edit</button>
        <button onclick="genLinks(${i})" style="padding:6px 8px;border-radius:6px;margin-right:6px">Copy Links</button>
        <button onclick="delLeader(${i})" style="padding:6px 8px;border-radius:6px;background:#ff6b6b;color:#fff;border:none;border-radius:6px">Hapus</button>
      </td>
    </tr>`;
  })
  html += '</tbody></table>';
  tableWrap.innerHTML = html;
}

/* ---------- actions ---------- */
btnAdd.onclick = async ()=>{
  const name = inName.value.trim();
  const phone = inPhone.value.trim().replace(/\s+/g,'');
  let slug = inSlug.value.trim();
  if(!name || !phone){ alert('Nama dan nomor WA wajib diisi'); return; }
  if(!slug) slug = slugify(name);
  // photo -> read as dataURL
  let photoData = null;
  if(inPhoto.files && inPhoto.files[0]){
    photoData = await fileToDataURL(inPhoto.files[0]);
  }
  const arr = loadLeaders();
  // if same phone or slug exists, update instead of push? We push new unless phone exists
  const existsIndex = arr.findIndex(x=>x.phone===phone || x.slug===slug);
  const obj = { name, phone, slug, photo: photoData };
  if(existsIndex>=0){
    arr[existsIndex] = obj;
    toast('Leader diperbarui');
  } else {
    arr.push(obj);
    toast('Leader ditambahkan');
  }
  saveLeaders(arr);
  inName.value=''; inPhone.value=''; inSlug.value=''; inPhoto.value='';
  renderTable();
}

/* file -> dataURL */
function fileToDataURL(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = e=>res(e.target.result);
    r.readAsDataURL(file);
  })
}

window.editLeader = (i)=>{
  const arr = loadLeaders();
  if(!arr[i]) return;
  const l = arr[i];
  inName.value = l.name;
  inPhone.value = l.phone;
  inSlug.value = l.slug || '';
  // note: photo cannot be set to file input programmatically for security; leave it to user
  window.scrollTo({top:0,behavior:'smooth'});
}

window.delLeader = (i)=>{
  if(!confirm('Hapus leader ini?')) return;
  const arr = loadLeaders();
  arr.splice(i,1);
  saveLeaders(arr);
  renderTable();
}

/* export JSON */
btnExport.onclick = ()=>{
  const arr = loadLeaders();
  if(!arr.length){ alert('Belum ada leader'); return; }
  download('leaders.json', JSON.stringify(arr, null, 2));
  toast('File leaders.json siap diupload ke repo (/data/leaders.json)');
}

/* clear LS */
btnClear.onclick = ()=>{
  if(!confirm('Hapus semua data di localStorage?')) return;
  localStorage.removeItem(LS_KEY);
  renderTable();
  toast('localStorage dibersihkan');
}

/* copy links for selected leader */
function makeLinksFor(l){
  const base = 'https://3ireborn.github.io/pendaftaran-online';
  const master = `${base}/lp-master-v6.6.html?leader=${encodeURIComponent(l.slug)}&wa=${encodeURIComponent(l.phone)}`;
  const hot = `${base}/lp-hot-v6.6.html?leader=${encodeURIComponent(l.slug)}&wa=${encodeURIComponent(l.phone)}`;
  const reg = `${base}/index-v2.html?leader=${encodeURIComponent(l.slug)}&wa=${encodeURIComponent(l.phone)}`;
  return { master, hot, reg };
}

window.genLinks = (i)=>{
  const arr = loadLeaders(); if(!arr[i]) return;
  const l = arr[i];
  const links = makeLinksFor(l);
  const txt = `LP Master:\n${links.master}\n\nLP Hot:\n${links.hot}\n\nForm Pendaftaran:\n${links.reg}`;
  copyText(txt);
}

/* UI copy from select */
btnCopyLinks.onclick = ()=>{
  const idx = selectLeader.value;
  if(idx===''||idx===null){ alert('Pilih leader dulu'); return; }
  const arr = loadLeaders();
  const l = arr[parseInt(idx)];
  const links = makeLinksFor(l);
  const txt = `ðŸ”¥ LP Master:\n${links.master}\n\nðŸ”¥ LP Hot:\n${links.hot}\n\nðŸ“ Form Pendaftaran:\n${links.reg}`;
  copyText(txt);
  toast('3 link disalin ke clipboard');
}

/* generate QR via qrserver.com and preview social card */
btnGenQR.onclick = ()=>{
  const idx = selectLeader.value;
  if(idx===''||idx===null){ alert('Pilih leader'); return; }
  const arr = loadLeaders(); const l = arr[parseInt(idx)];
  const links = makeLinksFor(l);
  // use registration link as primary
  const url = links.reg;
  const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(url)}&bgcolor=ffffff&color=ffcc00`;
  pvQrImg.src = qrSrc;
  pvName.textContent = l.name;
  pvAvatar.src = l.photo || 'data:image/svg+xml;utf8,' + encodeURIComponent(svgPlaceholder(l.name));
  preview.style.display = 'block';
  // scroll to preview
  preview.scrollIntoView({behavior:'smooth'});
}

/* svg placeholder */
function svgPlaceholder(name){
  const initials = name.split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
  return `<svg xmlns='http://www.w3.org/2000/svg' width='320' height='320'><rect width='100%' height='100%' fill='#0b2030'/><text x='50%' y='54%' font-size='72' fill='#ffd24d' text-anchor='middle' font-family='Poppins,Arial' font-weight='700'>${initials}</text></svg>`;
}

/* Download social card using html2canvas */
btnDownloadCard.onclick = async ()=>{
  if(preview.style.display==='none'){ alert('Generate preview dulu'); return; }
  const node = document.getElementById('cardWrap');
  html2canvas(node, {backgroundColor: null, scale:2}).then(canvas=>{
    canvas.toBlob(blob=>{
      downloadFile('social-card.png', blob);
    }, 'image/png');
  });
}

/* Generate LP redirect HTML (small file that redirects to LP with query) */
btnGenRedirect.onclick = ()=>{
  const idx = selectLeader.value;
  if(idx===''||idx===null){ alert('Pilih leader'); return; }
  const arr = loadLeaders(); const l = arr[parseInt(idx)];
  const base = 'https://3ireborn.github.io/pendaftaran-online/index-v2.html';
  const dest = `${base}?leader=${encodeURIComponent(l.slug)}&wa=${encodeURIComponent(l.phone)}`;
  const html = `<!doctype html><html><head><meta charset="utf-8"><meta http-equiv="refresh" content="0;url=${dest}"><title>Redirect</title></head><body>Redirecting... <a href="${dest}">${dest}</a></body></html>`;
  download('lp-redirect-'+l.slug+'.html', html);
}

/* toast (simple) */
function toast(msg){ console.log(msg); alert(msg); }

/* init render */
renderTable();

</script>
</body>
  </html>
