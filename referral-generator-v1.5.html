<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Referral Generator ‚Äî NPA Smart / 3iReborn (v1.0F)</title>
  <style>
    :root{--bg:#071229;--card:#0b1730;--muted:#a9b3c7;--accent:#1A73E8;--gold:#f5c542}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,#031026 0%, #071229 100%);color:#e7eefc}
    .wrap{max-width:720px;margin:28px auto;padding:20px}
    h1{margin:0 0 8px;font-size:22px;color:var(--accent)}
    p.lead{margin:0 0 18px;color:var(--muted)}.card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(3,7,18,.6);border:4px solid rgba(0,0,0,0.15)}

/* gold outer stroke */
.frame{padding:8px;border-radius:14px;border:4px solid var(--gold);}

label{display:block;font-weight:600;margin-top:12px;color:#dff0ff}
input[type=text], input[type=file]{width:100%;padding:14px;border-radius:12px;border:2px solid rgba(26,115,232,.25);background:rgba(255,255,255,0.02);color:#fff;box-sizing:border-box}
input[type=text]::placeholder{color:#7f94b7}

.btn{display:inline-block;padding:12px 18px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),#5aa6ff);color:#fff;font-weight:700;cursor:pointer;margin-top:14px}
.btn.ghost{background:transparent;border:2px solid rgba(255,255,255,0.06)}
.btn.copy{background:linear-gradient(90deg,#2bb673,#00d17a)}

.links .linkbox{margin-top:14px;padding:12px;border-radius:10px;border:2px solid rgba(26,115,232,.35);background:linear-gradient(180deg, rgba(10,20,40,.6), rgba(6,12,23,.5));word-break:break-all}
.controls{display:flex;gap:8px;flex-wrap:wrap}

.preview{margin-top:18px;display:grid;grid-template-columns:1fr;gap:12px}
.qr{width:260px;height:260px;background:#fff;border-radius:6px;display:block}

.social-card{width:600px;height:750px;background:#fff;color:#111;border-radius:16px;padding:22px;box-sizing:border-box}
.card-top{display:flex;gap:12px;align-items:center}
.p-foto{width:120px;height:120px;border-radius:12px;background:#e6eefc;overflow:hidden;flex-shrink:0}
.p-foto img{width:100%;height:100%;object-fit:cover}
.card-title{font-size:22px;font-weight:800;color:#0b2b66}
.card-sub{margin-top:6px;color:#2e3d6b}
.card-qr{position:absolute;right:22px;bottom:22px}

.note{font-size:13px;color:var(--muted);margin-top:10px}

/* responsive */
@media(max-width:640px){.social-card{width:360px;height:480px}}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <div class="card">
        <h1>Referral Generator ‚Äî NPA Smart / 3iReborn (v1.0F)</h1>
        <p class="lead">Buat LP Master, LP Hot, Form pendaftaran & social card (PNG) per leader. QR otomatis, tombol Share WA, Copy all links.</p><label>1) Nama Leader (tampil di card)</label>
    <input id="inpName" type="text" placeholder="Contoh: Sugiarto KSM" value="" />

    <label>2) No. WhatsApp (format: 628...)</label>
    <input id="inpWA" type="text" placeholder="Contoh: 6285218453131" value="" />

    <label>3) Slug (unik, tanpa spasi) ‚Äî masukan slug custom di sini</label>
    <input id="inpSlug" type="text" placeholder="Contoh: sugiarto-ksm" value="" />

    <label>4) Upload Foto Leader (opsional ‚Äî hanya untuk social card)</label>
    <input id="inpFile" type="file" accept="image/*" />

    <div class="controls">
      <button id="btnCreate" class="btn">üöÄ Buat Link & QR</button>
      <button id="btnReset" class="btn ghost">üîÅ Reset</button>
      <button id="btnCopyAll" class="btn copy">üìã Copy Semua Link</button>
      <button id="btnSaveAll" class="btn ghost" title="Simpan PNG social card">üíæ Save Card (PNG)</button>
    </div>

    <div class="note">Tip: gunakan tombol <strong>Bagikan ke WhatsApp</strong> untuk sharing cepat ke grup/teman. QR dan PNG dapat dipakai untuk cetak brosur.</div>

    <div class="preview" id="previewArea">
      <!-- live links & QR appear here -->
    </div>

  </div>
</div>

  </div><script>
  // base URLs (editable if repo path changes)
  const BASE = location.origin + location.pathname.replace(/[^\/]*$/, '');
  const LP_MASTER = BASE + 'lp-master-v6.6.html';
  const LP_HOT = BASE + 'lp-hot-v6.6.html';
  const FORM = BASE + 'index-v2.html';

  const $ = id => document.getElementById(id);
  const inpName = $('inpName');
  const inpWA = $('inpWA');
  const inpSlug = $('inpSlug');
  const inpFile = $('inpFile');
  const btnCreate = $('btnCreate');
  const btnReset = $('btnReset');
  const btnCopyAll = $('btnCopyAll');
  const btnSaveAll = $('btnSaveAll');
  const previewArea = $('previewArea');

  function sanitizeSlug(s){
    return String(s||'').toLowerCase().trim().replace(/[^a-z0-9\-]/g,'-').replace(/\-+/g,'-').replace(/^\-|\-$/g,'') || '';
  }

  function buildLinks(name, wa, slug){
    const ref = encodeURIComponent(slug || '');
    const waParam = wa ? '&wa=' + encodeURIComponent(wa) : '';
    const master = LP_MASTER + '?ref=' + ref + waParam;
    const hot = LP_HOT + '?ref=' + ref + waParam;
    const form = FORM + '?leader=' + ref + waParam;
    return {master, hot, form};
  }

  function qrUrl(text,size=300){
    return 'https://chart.googleapis.com/chart?cht=qr&chs='+size+'x'+size+'&chl='+encodeURIComponent(text)+'&chld=L|1';
  }

  function makeCaption(name, links){
    return `${name} ‚Äî Info lengkap:\nLP Master: ${links.master}\nLP Hot: ${links.hot}\nForm: ${links.form}\n\nGabung sekarang!`;
  }

  function createSocialCardDataURL(name, photoURL, qrDataURL, links, cb){
    // draw on canvas
    const canvas = document.createElement('canvas');
    canvas.width = 1200; canvas.height = 1500; // high-res
    const ctx = canvas.getContext('2d');

    // background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // left top photo box
    const pad = 60;
    const photoX = pad; const photoY = pad; const photoW = 360; const photoH = 360;

    // rounded rect for photo
    ctx.fillStyle = '#eef5ff';
    roundRect(ctx, photoX-6, photoY-6, photoW+12, photoH+12, 28, true, false);

    if(photoURL){
      const img = new Image(); img.crossOrigin='anonymous'; img.onload = ()=>{
        ctx.drawImage(img, photoX, photoY, photoW, photoH);
        drawTextAndQR();
      }; img.onerror=()=>{ drawTextAndQR(); }; img.src = photoURL;
    } else drawTextAndQR();

    function drawTextAndQR(){
      // title
      ctx.fillStyle = '#0b2b66';
      ctx.font = 'bold 60px sans-serif';
      ctx.fillText(''+name, photoX + photoW + 30, photoY + 80);

      ctx.font = '22px sans-serif'; ctx.fillStyle='#1f3b73';
      wrapText(ctx, 'Tautan: '+ links.master, photoX + photoW + 30, photoY + 130, 700, 28);

      // QR image
      const qr = new Image(); qr.crossOrigin='anonymous'; qr.onload = ()=>{
        const qSize = 360;
        ctx.drawImage(qr, canvas.width - pad - qSize, canvas.height - pad - qSize, qSize, qSize);
        // small footer
        ctx.fillStyle='#233a6b'; ctx.font='18px sans-serif';
        ctx.fillText('Powered by NPA Smart System | 3iReborn', pad, canvas.height - 28);
        cb(canvas.toDataURL('image/png'));
      }; qr.onerror=()=>{ cb(canvas.toDataURL('image/png')); };
      qr.src = qrDataURL;
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if (typeof r === 'undefined') r = 5;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';
    for (let n = 0; n < words.length; n++) {
      const testLine = line + words[n] + ' ';
      const metrics = ctx.measureText(testLine);
      const testWidth = metrics.width;
      if (testWidth > maxWidth && n > 0) {
        ctx.fillText(line, x, y);
        line = words[n] + ' ';
        y += lineHeight;
      }
      else {
        line = testLine;
      }
    }
    ctx.fillText(line, x, y);
  }

  // --- events ---
  let currentPNG = null;
  let currentLinks = null;

  btnCreate.addEventListener('click', ()=>{
    const name = inpName.value.trim() || 'Leader';
    const wa = inpWA.value.trim();
    const slug = sanitizeSlug(inpSlug.value) || 'leader-'+Date.now();
    inpSlug.value = slug;
    currentLinks = buildLinks(name, wa, slug);

    // build preview
    previewArea.innerHTML = '';

    const divLinks = document.createElement('div'); divLinks.className='links';
    const boxMaster = document.createElement('div'); boxMaster.className='linkbox'; boxMaster.textContent = currentLinks.master;
    const btnCopyMaster = document.createElement('button'); btnCopyMaster.className='btn ghost'; btnCopyMaster.textContent='Copy'; btnCopyMaster.onclick = ()=>copyText(currentLinks.master);
    const boxHot = document.createElement('div'); boxHot.className='linkbox'; boxHot.textContent = currentLinks.hot;
    const btnCopyHot = btnCopyMaster.cloneNode(true); btnCopyHot.onclick = ()=>copyText(currentLinks.hot);
    const boxForm = document.createElement('div'); boxForm.className='linkbox'; boxForm.textContent = currentLinks.form;
    const btnCopyForm = btnCopyMaster.cloneNode(true); btnCopyForm.onclick = ()=>copyText(currentLinks.form);

    divLinks.appendChild(boxMaster); divLinks.appendChild(btnCopyMaster);
    divLinks.appendChild(boxHot); divLinks.appendChild(btnCopyHot);
    divLinks.appendChild(boxForm); divLinks.appendChild(btnCopyForm);

    previewArea.appendChild(divLinks);

    // QR
    const qrImg = document.createElement('img'); qrImg.className='qr'; qrImg.src = qrUrl(currentLinks.master, 520);
    previewArea.appendChild(qrImg);

    // share button
    const shareBtn = document.createElement('button'); shareBtn.className='btn copy'; shareBtn.textContent='Bagikan ke WhatsApp';
    shareBtn.onclick = ()=>{
      const caption = makeCaption(name, currentLinks);
      const url = 'https://wa.me/?text='+encodeURIComponent(caption);
      window.open(url,'_blank');
    };
    previewArea.appendChild(shareBtn);

    // social card generation
    const reader = new FileReader();
    if(inpFile.files && inpFile.files[0]){
      reader.onload = e => {
        const photoURL = e.target.result;
        createSocialCardDataURL(name, photoURL, qrUrl(currentLinks.master,600), currentLinks, (png)=>{
          currentPNG = png;
          addDownloadButtons(png);
        });
      };
      reader.readAsDataURL(inpFile.files[0]);
    } else {
      createSocialCardDataURL(name, null, qrUrl(currentLinks.master,600), currentLinks, (png)=>{
        currentPNG = png; addDownloadButtons(png);
      });
    }

  });

  function addDownloadButtons(png){
    const down = document.createElement('a'); down.className='btn'; down.textContent='Download Social Card (PNG)'; down.href = png; down.download = 'social-card.png';
    previewArea.appendChild(down);

    const img = document.createElement('img'); img.src = png; img.style.maxWidth='320px'; img.style.borderRadius='8px'; img.style.marginTop='12px';
    previewArea.appendChild(img);
  }

  btnCopyAll.addEventListener('click', ()=>{
    if(!currentLinks) return alert('Buat link dulu');
    const txt = `LP Master: ${currentLinks.master}\nLP Hot: ${currentLinks.hot}\nForm: ${currentLinks.form}`;
    copyText(txt); alert('Semua link disalin ke clipboard');
  });

  btnSaveAll.addEventListener('click', ()=>{
    if(!currentPNG) return alert('Buat dulu social card');
    // trigger download
    const a = document.createElement('a'); a.href = currentPNG; a.download = (inpSlug.value||'card') + '.png'; a.click();
  });

  btnReset.addEventListener('click', ()=>{ inpName.value=''; inpWA.value=''; inpSlug.value=''; inpFile.value=''; previewArea.innerHTML=''; currentPNG=null; currentLinks=null; });

  function copyText(text){ navigator.clipboard?.writeText(text).catch(()=>{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();}); }

  // auto-generate slug on name change (non-forcing)
  inpName.addEventListener('blur', ()=>{ if(!inpSlug.value.trim()) inpSlug.value = sanitizeSlug(inpName.value); });

</script></body>
</html>
