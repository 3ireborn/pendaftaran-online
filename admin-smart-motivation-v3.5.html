<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NPA Motivation v3.5 â€” PWA AutoScheduler</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b3d91" />
<style>
body{font-family:Poppins,system-ui,sans-serif;background:#f5f7fa;margin:0;padding:20px;color:#222}
.wrap{max-width:800px;margin:auto;background:#fff;border-radius:18px;box-shadow:0 8px 26px rgba(0,0,0,.08);padding:24px}
h1{color:#0b3d91;margin:0 0 4px}
.sub{color:#667;margin-bottom:14px}
.btn{background:#0b3d91;color:#fff;border:0;padding:10px 16px;border-radius:10px;cursor:pointer;margin:4px 0;display:inline-block}
.btn.alt{background:#eaf2ff;color:#0b3d91}
select,input{padding:8px 10px;border:1px solid #ccd;border-radius:8px;margin:4px 0}
.msg{background:#eef5ff;border-left:5px solid #0b3d91;padding:12px;border-radius:8px;margin:10px 0}
.footer{text-align:center;margin-top:18px;color:#778}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’¬ NPA Motivation v3.5</h1>
  <p class="sub">PWA AutoScheduler â€¢ Daily WhatsApp Motivation</p>

  <select id="target">
    <option value="leader">Target: Leader</option>
    <option value="mitra">Target: Mitra</option>
  </select>
  <select id="weekday">
    <option value="Senin">Tema Senin</option>
    <option value="Selasa">Tema Selasa</option>
    <option value="Rabu">Tema Rabu</option>
    <option value="Kamis">Tema Kamis</option>
    <option value="Jumat">Tema Jumat</option>
    <option value="Sabtu">Tema Sabtu</option>
    <option value="Minggu">Tema Minggu</option>
  </select>
  <input id="sendTime" type="time" value="07:00" />

  <button class="btn alt" id="btnLoad">ğŸ”„ Muat Pesan</button>
  <div class="msg" id="motivation">Memuat pesan motivasi...</div>
  <button class="btn" id="btnSendAll">ğŸš€ Kirim ke WhatsApp</button>

  <div class="footer">
    Powered by <b>NPA</b> â•‘ 3iReborn Smart System ğŸ’™<br>
    <small id="status">Menunggu jadwal otomatis...</small>
  </div>
</div>

<script>
// === Service Worker (PWA) ===
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
  .then(()=>console.log('Service Worker aktif âœ…'));
}

// === Fetch data ===
let DATA_LEADERS=[],DATA_MITRA=[],WEEKLY={};
Promise.all([
  fetch('data/leaders.json').then(r=>r.json()),
  fetch('data/mitra.json').then(r=>r.json()),
  fetch('data/motivation-weekly.json').then(r=>r.json())
]).then(([L,M,W])=>{
  DATA_LEADERS=L; DATA_MITRA=M; WEEKLY=W;
  loadMsg();
  autoScheduler();
});

const $=s=>document.querySelector(s);
const pick=a=>a[Math.floor(Math.random()*a.length)];
const buildMsg=(n,b)=>`Assalamu'alaikum ${n} ğŸ™ğŸ»%0A%0A${b}%0A%0ASalam semangat dari *NPA Smart System ğŸ’™*%0A3iReborn Digital Ecosystem ğŸš€`;
const buildLink=(p,t)=>`https://wa.me/${p}?text=${encodeURIComponent(t)}`;
function today(){return ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][new Date().getDay()];}

function loadMsg(){
  const d=$("#weekday").value;
  const arr=WEEKLY[d]||["Hari baru, semangat baru ğŸ’ª"];
  const msg=pick(arr);
  $("#motivation").textContent=msg;
}

function sendAll(){
  const t=$("#target").value;
  const data=(t==='leader')?DATA_LEADERS:DATA_MITRA;
  const base=$("#motivation").textContent;
  data.forEach((p,i)=>{
    setTimeout(()=>{
      const u=buildLink(p.phone,decodeURIComponent(buildMsg(p.name,base)));
      window.open(u,'_blank');
    },i*4000);
  });
}

function autoScheduler(){
  const lastKey='npa_last_sent';
  setInterval(()=>{
    const now=new Date();
    const hh=String(now.getHours()).padStart(2,'0');
    const mm=String(now.getMinutes()).padStart(2,'0');
    const target=$("#sendTime").value||'07:00';
    const day=today();
    const last=localStorage.getItem(lastKey);
    if(hh+':'+mm===target && last!==day){
      $("#status").textContent='â° Mengirim motivasi otomatis...';
      sendAll();
      localStorage.setItem(lastKey,day);
      new Notification("Motivasi dikirim ğŸ‰",{body:`Tema ${day} terkirim ke semua mitra.`});
    }
  },30000);
}

$("#btnLoad").onclick=loadMsg;
$("#btnSendAll").onclick=sendAll;
$("#weekday").onchange=loadMsg;
</script>
</body>
</html>
