<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Form Pendaftaran 3iReborn ‚Äî v3.0 (Save + WA)</title>
<link rel="icon" href="data:,">
<style>
 :root{--bg:#f6f9ff;--card:#fff;--text:#17324a;--muted:#6b7b8d;--pri:#1a73e8;--ok:#16a34a;--warn:#eab308;--danger:#dc2626;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:860px;margin:24px auto;padding:16px}
.card{background:var(--card);border-radius:18px;padding:22px 20px;box-shadow:0 12px 30px rgba(13,31,62,.06)}
h1{font-size:28px;margin:0 0 6px}
.sub{color:var(--muted);margin:0 0 18px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:780px){.row{grid-template-columns:1fr}}
.label{font-weight:650;margin:12px 0 8px}
.input,select{width:100%;padding:14px 14px;border:1px solid #dde7fb;border-radius:12px;background:#fbfdff;color:#0b2540;outline:none}
.input:focus,select:focus{border-color:#b7cdfd;box-shadow:0 0 0 4px rgba(26,115,232,.12)}
.btn{appearance:none;border:0;border-radius:12px;padding:14px 18px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--pri);color:#fff}
.btn-ghost{background:#eef4ff;color:#18345b}
.btn-ok{background:var(--ok);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#eef6ff;color:#234}
.small{color:var(--muted);font-size:13px}
hr{border:0;border-top:1px solid #e9f0ff;margin:18px 0}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b2540;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:9999}
.kv{display:flex;gap:6px;flex-wrap:wrap}
.kv .item{background:#f1f6ff;border:1px solid #e3eeff;border-radius:10px;padding:8px 10px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)}
.footer{margin:18px auto 8px;color:#6b7b8d;text-align:center}
a{color:var(--pri);text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Form Pendaftaran</h1>
    <p class="sub" id="lead-sub">Leader: - ‚Ä¢ WA: - ‚Ä¢ slug: -</p>

    <div class="row">
      <div>
        <div class="label">Nama Lengkap</div>
        <input id="nama" class="input" placeholder="cth: Budi Santoso" autocomplete="name">
      </div>
      <div>
        <div class="label">No. WhatsApp (62‚Ä¶)</div>
        <input id="wa" class="input" placeholder="62812xxxxxxx" inputmode="numeric" autocomplete="tel">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <div class="label">Pilihan Premi</div>
        <select id="premi">
          <option value="350000">Rp 350.000</option>
          <option value="700000">Rp 700.000</option>
          <option value="1000000">Rp 1.000.000</option>
          <option value="2000000">Rp 2.000.000</option>
        </select>
        <div class="small" style="margin-top:6px">* Premi dapat dikonsultasikan saat follow-up.</div>
      </div>
      <div>
        <div class="label">Kota/Provinsi <span class="small">(opsional)</span></div>
        <input id="kota" class="input" placeholder="cth: Tangerang, Banten" autocomplete="address-level2">
      </div>
    </div>

    <div class="actions">
      <button id="btn-submit" class="btn btn-primary">Kirim & Simpan</button>
      <button id="btn-test" class="btn btn-ghost">Test Isi Otomatis</button>
      <button id="btn-token" class="btn btn-ok"><span class="dot warn" id="dot"></span>Set Token GitHub</button>
      <a id="btn-back" class="btn btn-ghost" href="#">Kembali ke LP Master</a>
    </div>

    <hr>
    <div class="badge">
      <strong>Status Simpan:</strong>
      <span id="status">Menunggu‚Ä¶</span>
    </div>
    <div class="kv" id="kv"></div>

    <p class="small" style="margin-top:10px">Data akan disimpan ke
      <code>data/mitra.json</code> di repo GitHub bila token di-set. Setelah tersimpan, pesan pendaftaran
      otomatis dikirim ke WhatsApp Leader.
    </p>
  </div>

  <p class="footer">NPA Smart System √ó 3iReborn ‚Ä¢ <a href="./lp-master.html">LP Master</a> ‚Ä¢
    <a href="./lp-hot.html">LP Hot</a></p>
</div>

<script>
/* ==========
   Config dasar (boleh dibiarkan)
========== */
const GH = {
  owner: "3ireborn",
  repo: "pendaftaran-online",
  path: "data/mitra.json",
  tokenKey: "gh_token_3ireborn"
};

// ambil param leader dari URL (dikirim dari Admin v4.8)
const q = new URLSearchParams(location.search);
const LEADER = {
  name: q.get("name") || q.get("leader") || "-",
  wa:   q.get("wa")   || q.get("phone")  || "-",
  slug: q.get("slug") || (q.get("name") ? slugify(q.get("name")) : "-")
};

// tampilkan subheader & link kembali ke LP Master
document.getElementById("lead-sub").textContent =
  `Leader: ${LEADER.name} ‚Ä¢ WA: ${LEADER.wa} ‚Ä¢ slug: ${LEADER.slug}`;
document.getElementById("btn-back").href =
  `./lp-master.html?name=${enc(LEADER.name)}&wa=${enc(LEADER.wa)}&slug=${enc(LEADER.slug)}`;

// util
function enc(s){return encodeURIComponent(s||"")}
function slugify(s){return (s||"").toLowerCase().trim()
  .replace(/[^\p{L}\p{N}]+/gu,"-").replace(/(^-|-$)+/g,"")}
function toast(msg,ms=1800){
  const t=document.createElement("div"); t.className="toast"; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),ms);
}
function setStatus(html){ document.getElementById("status").innerHTML = html }
function dotPaint(){ document.getElementById("dot").className = "dot " + (getToken()?"ok":"warn") }
function getToken(){ return localStorage.getItem(GH.tokenKey)||"" }
function setToken(tok){ localStorage.setItem(GH.tokenKey,tok||""); dotPaint() }

// tombol set token
document.getElementById("btn-token").onclick=()=>{
  const cur=getToken();
  const t=prompt("Tempel Token GitHub (scope: repo):", cur ? obfuscate(cur) : "");
  if(t===null) return;
  const plain = deobfuscateIfNeeded(t.trim());
  setToken(plain);
  toast(plain? "‚úÖ Token disimpan":"‚ö†Ô∏è Token dihapus");
};

// isi otomatis (buat test cepat)
document.getElementById("btn-test").onclick=()=>{
  const n = document.getElementById("nama");
  const w = document.getElementById("wa");
  if(!n.value) n.value = "Budi Santoso";
  if(!w.value) w.value = "62812" + Math.floor(1000000 + Math.random()*8999999);
  toast("Contoh data diisi üëç");
};

// submit
document.getElementById("btn-submit").onclick=async ()=>{
  const data = readForm();
  if(!data) return;
  const hasToken = !!getToken();

  // 1) Simpan (jika ada token)
  if(hasToken){
    setStatus("‚è≥ menyimpan ke GitHub‚Ä¶");
    try{
      await saveToGitHub(data);
      setStatus("‚úÖ tersimpan ke GitHub");
      toast("Data tersimpan ke GitHub");
    }catch(e){
      console.error(e);
      setStatus("‚ùå gagal simpan ke GitHub ‚Äî lanjut kirim WA saja.");
      toast("Gagal simpan. Tetap kirim WA.");
    }
  }else{
    setStatus("‚ö†Ô∏è token tidak ada ‚Äî lewati simpan, kirim WA saja.");
  }

  // 2) Kirim WA ke Leader
  sendToWhatsApp(data);
};

function readForm(){
  const nama = document.getElementById("nama").value.trim();
  const wa   = document.getElementById("wa").value.trim();
  const premi= document.getElementById("premi").value;
  const kota = document.getElementById("kota").value.trim();

  if(!nama){ toast("Nama wajib diisi"); document.getElementById("nama").focus(); return null }
  if(!/^62\d{6,15}$/.test(wa)){ toast("WA harus diawali 62 dan angka saja"); document.getElementById("wa").focus(); return null }

  const rec = {
    ts: new Date().toISOString(),
    calon_nama: nama,
    calon_wa: wa,
    calon_kota: kota||"",
    premi: Number(premi),
    leader: {...LEADER}
  };

  // tampilkan ringkas
  const kv = document.getElementById("kv"); kv.innerHTML="";
  for(const [k,v] of Object.entries(rec)){
    const d=document.createElement("div"); d.className="item"; d.textContent = k+": "+(typeof v==="object"? JSON.stringify(v): v);
    kv.appendChild(d);
  }
  return rec;
}

/* ==========
   Simpan ke GitHub (contents API)
========== */
async function saveToGitHub(newRec){
  const token = getToken();
  const base = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`;

  // 1. ambil file (kalau ada)
  let sha=null, arr=[];
  const getRes = await fetch(base, {headers:{Authorization:`token ${token}`}});

  if(getRes.status===200){
    const j = await getRes.json();
    sha = j.sha;
    const content = JSON.parse(atob(j.content.replace(/\n/g,"")));
    arr = Array.isArray(content)? content : [];
  }else if(getRes.status===404){
    // belum ada file ‚Äî buat baru
    arr=[];
  }else{
    const msg = await getRes.text();
    throw new Error("GET mitra.json gagal: "+msg);
  }

  // 2. push record
  arr.push(newRec);
  const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(arr,null,2))));

  // 3. commit PUT
  const body = {
    message: `add: mitra ${newRec.calon_nama} (${newRec.calon_wa})`,
    content: newContent,
    branch: "main"
  };
  if(sha) body.sha = sha;

  const putRes = await fetch(base, {
    method: "PUT",
    headers: { "Authorization": `token ${token}`, "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  if(!putRes.ok){
    const t = await putRes.text();
    throw new Error("PUT mitra.json gagal: "+t);
  }
}

/* ==========
   Kirim WhatsApp ke Leader
========== */
function sendToWhatsApp(rec){
  const premiFmt = new Intl.NumberFormat("id-ID").format(rec.premi);
  const text =
`Assalamualaikum üôè

Saya *${rec.calon_nama}* berminat bergabung 3iReborn.

Data singkat:
‚Ä¢ WA: ${rec.calon_wa}
‚Ä¢ Kota: ${rec.calon_kota||"-"}
‚Ä¢ Premi pilihan: Rp ${premiFmt}

Mohon bimbingannya, Leader *${LEADER.name}*.

#Registrasi #3iReborn #NPASmartSystem`;

  const url = `https://wa.me/${LEADER.wa}?text=${encodeURIComponent(text)}`;
  setStatus("üì® membuka WhatsApp‚Ä¶");
  window.location.href = url;
}

/* ==========
   Token helper (biar kalau kepencet tempel yang tersamar masih bisa)
========== */
function obfuscate(t){ if(!t) return ""; return t.slice(0,4)+"‚Ä¢‚Ä¢‚Ä¢"+t.slice(-4) }
function deobfuscateIfNeeded(t){ return t.includes("‚Ä¢‚Ä¢‚Ä¢") ? "" : t }

dotPaint();
</script>
</body>
</html>
