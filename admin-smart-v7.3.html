<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NPA Smart v7.5 ‚Äî Admin Pusat (Dark Elegant)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220;
  --card:#0f1724;
  --muted:#9aa7bd;
  --accent:#28cdb3;
  --accent-2:#6ee7b7;
  --glass: rgba(255,255,255,0.03);
  --glass-2: rgba(255,255,255,0.02);
  --danger:#ff6b6b;
  --success:#4ade80;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#071124 0%, #07142a 60%);color:#e6f0ff;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif;min-height:100vh}
.wrap{max-width:980px;margin:28px auto;padding:22px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.h-title{font-size:30px;font-weight:800;line-height:1;color:#cfefff}
.h-sub{color:var(--muted);font-size:13px;margin-top:6px}
.card{background:linear-gradient(180deg,var(--card), #071426);border:1px solid rgba(255,255,255,0.03);border-radius:14px;padding:16px;margin-top:18px;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
.kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.pill{background:var(--glass);border-radius:12px;padding:12px}
.pill b{display:block;font-size:20px;color:#e6f0ff}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input, .select, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6f0ff}
.btn{cursor:pointer;border:0;padding:10px 16px;border-radius:10px;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#022;box-shadow:0 6px 18px rgba(32,200,170,0.12)}
.btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.04)}
.btn-danger{background:var(--danger);color:#111}
.log{max-height:220px;overflow:auto;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.015));border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
.small{font-size:13px;color:var(--muted);margin-top:6px}
.center{text-align:center}
.modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:999}
.modal{width:420px;background:linear-gradient(180deg,#071426,#0c2635);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.field{margin-bottom:10px}
.toast-wrap{position:fixed;right:18px;bottom:18px;z-index:10000;display:flex;flex-direction:column;gap:8px}
.toast{background:#0b1720;color:#e6fff5;padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-weight:600}
.footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
@media (max-width:640px){.modal{width:92%}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="h-title">NPA Smart v7.5 ‚Äî Admin Pusat</div>
      <div class="h-sub">Dark Elegant ‚Ä¢ Token FonNTE, Token GitHub, Tambah Mitra & Sinkron</div>
    </div>
    <div class="center">
      <div class="badge" id="clock">--:--:--</div>
      <div class="small" style="margin-top:6px" id="leadCountWrap">Leader Aktif: <b id="leadCount">0</b></div>
    </div>
  </div>

  <!-- TOKENS -->
  <div class="card">
    <h3>üîë Token FonNTE (untuk kirim WA)</h3>
    <div class="field"><input id="tokenFonnte" class="input" placeholder="Tempel token FonNTE di sini" /></div>
    <div class="row" style="margin-top:6px">
      <button id="saveFonnte" class="btn btn-primary">Simpan Token FonNTE</button>
      <button id="testFonnte" class="btn btn-ghost">Tes Token</button>
      <button id="delFonnte" class="btn btn-danger">Hapus</button>
    </div>
    <div class="note" id="fonnteStatus">Token FonNTE belum disimpan.</div>
  </div>

  <!-- GITHUB TOKEN & REPO -->
  <div class="card">
    <h3>üì¶ Token GitHub & Pengaturan Repo (untuk sinkron leader.json)</h3>
    <div class="field"><input id="tokenGithub" class="input" placeholder="ghp_xxx (Token GitHub ‚Äî hak akses repo)" /></div>
    <div class="row">
      <div style="flex:1"><input id="ghOwner" class="input" placeholder="Owner GitHub (username/org)" /></div>
      <div style="flex:1"><input id="ghRepo" class="input" placeholder="Repo name (contoh: 3ireborn/pendaftaran-online -> isi pendaftar-online)" /></div>
    </div>
    <div class="field"><input id="ghPath" class="input" placeholder="Path file (contoh: data/leader.json  atau leader.json)" /></div>
    <div class="row" style="margin-top:6px">
      <button id="saveGit" class="btn btn-primary">Simpan Token GitHub</button>
      <button id="testGit" class="btn btn-ghost">Tes Token GitHub</button>
      <button id="syncNow" class="btn btn-ghost">Sinkronisasi ke GitHub</button>
    </div>
    <div class="note" id="gitStatus">Token GitHub belum disimpan.</div>
  </div>

  <!-- Manajemen Mitra -->
  <div class="card">
    <h3>üë• Manajemen Mitra</h3>
    <div class="row" style="margin-bottom:10px">
      <button id="btnAdd" class="btn btn-primary">‚ûï Tambah Mitra Baru</button>
      <button id="btnOpenCache" class="btn btn-ghost">üìÅ Lihat Cache Leader Lokal</button>
      <button id="btnExport" class="btn btn-ghost">‚¨áÔ∏è Export Cache</button>
    </div>
    <div class="small">Cache lokal: <span id="cacheInfo">(belum ada data)</span></div>
    <div class="note">Tambah mitra akan menyimpan ke cache lokal dan (opsional) push ke GitHub saat sinkronisasi.</div>
  </div>

  <!-- Manual Send -->
  <div class="card">
    <h3>üì£ Manual Follow-up</h3>
    <div class="row">
      <button id="sendPagi" class="btn btn-primary">üåÖ Kirim Motivasi Pagi (Manual)</button>
      <button id="sendSore" class="btn btn-primary">üåá Kirim Motivasi Sore (Manual)</button>
    </div>
    <div class="note">Auto follow-up akan mencoba mengirim pada 06:00 & 17:00 WIB jika halaman terbuka. Sistem tetap menyimpan log & cache.</div>
  </div>

  <!-- Log -->
  <div class="card">
    <h3>üìù Log Aktivitas</h3>
    <div id="logBox" class="log">(belum ada aktivitas)</div>
  </div>

  <div class="footer">NPA Smart ‚Ä¢ Jangan ubah urutan form pendaftaran (v3.3) ‚Äî Nama Ibu Kandung WAJIB ada.</div>
</div>

<!-- Modal Add Mitra -->
<div id="modalAdd" style="display:none" class="modal-back">
  <div class="modal">
    <h3 style="margin-top:0">Tambah Mitra Baru</h3>
    <div class="field"><input id="m_name" class="input" placeholder="Nama Lengkap" /></div>
    <div class="field"><input id="m_phone" class="input" placeholder="No. HP / WhatsApp (62...)" /></div>
    <div class="field"><input id="m_id" class="input" placeholder="No Identitas (optional)" /></div>
    <div class="row">
      <button id="modalSave" class="btn btn-primary">Simpan & Tambah ke Cache</button>
      <button id="modalCancel" class="btn btn-ghost">Batal</button>
    </div>
    <div class="small" style="margin-top:8px">Catatan: setelah tersimpan, tekan <b>Sinkronisasi ke GitHub</b> untuk push ke repo (jika diinginkan).</div>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
(function(){
  // --- Utilities ---
  const $ = id => document.getElementById(id);
  const nowTime = ()=> new Date().toLocaleTimeString('id-ID',{hour12:false});
  const toastWrap = $('toastWrap');
  function toast(msg){
    const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toastWrap.appendChild(d);
    setTimeout(()=>d.remove(),4500);
  }
  function log(msg, cls='') {
    const box=$('logBox');
    box.innerHTML = `<div class="${cls}">[${nowTime()}] ${msg}</div>` + box.innerHTML;
  }

  // clock
  function tick(){ $('clock').textContent = nowTime(); }
  tick(); setInterval(tick,1000);

  // --- Storage Keys ---
  const KEY_FONNTE = 'fonnte_token_v7';
  const KEY_GITHUB = 'gh_token_v7';
  const KEY_GH_OWNER = 'gh_owner_v7';
  const KEY_GH_REPO = 'gh_repo_v7';
  const KEY_GH_PATH = 'gh_path_v7';
  const KEY_LEADERS = 'npa_leaders_v7'; // local cache

  // Init UI from storage
  function initUI(){
    $('tokenFonnte').value = localStorage.getItem(KEY_FONNTE) || '';
    $('tokenGithub').value = localStorage.getItem(KEY_GITHUB) || '';
    $('ghOwner').value = localStorage.getItem(KEY_GH_OWNER) || '';
    $('ghRepo').value = localStorage.getItem(KEY_GH_REPO) || '';
    $('ghPath').value = localStorage.getItem(KEY_GH_PATH) || 'leader.json';
    const leaders = JSON.parse(localStorage.getItem(KEY_LEADERS) || '[]');
    updateLeadCount(leaders.length);
    $('cacheInfo').textContent = leaders.length ? leaders.length + ' mitra (cache lokal)' : '(belum ada data)';
    if(localStorage.getItem(KEY_FONNTE)) $('fonnteStatus').textContent = 'Token FonNTE tersimpan.';
    if(localStorage.getItem(KEY_GITHUB)) $('gitStatus').textContent = 'Token GitHub tersimpan.';
  }

  function updateLeadCount(n){ $('leadCount').textContent = n; }

  initUI();

  // --- FonNTE token actions ---
  $('saveFonnte').onclick = ()=>{
    const v=$('tokenFonnte').value.trim();
    if(!v){ toast('Masukkan token FonNTE dahulu'); return; }
    localStorage.setItem(KEY_FONNTE, v);
    $('fonnteStatus').textContent = 'Token FonNTE tersimpan.';
    toast('Token FonNTE disimpan');
    log('Token FonNTE disimpan ‚úÖ','ok');
  };
  $('delFonnte').onclick = ()=> {
    localStorage.removeItem(KEY_FONNTE);
    $('tokenFonnte').value = '';
    $('fonnteStatus').textContent = 'Token FonNTE belum disimpan.';
    toast('Token FonNTE dihapus');
    log('Token FonNTE dihapus üóëÔ∏è','err');
  };
  $('testFonnte').onclick = ()=> {
    const t = localStorage.getItem(KEY_FONNTE)||'';
    if(!t){ toast('Token FonNTE belum diset'); return; }
    // Dummy test: just show token masked
    const masked = t.slice(0,6) + '...' + t.slice(-4);
    toast('Token FonNTE: ' + masked);
    log('Tes Token FonNTE -> OK','ok');
  };

  // --- GitHub token actions ---
  $('saveGit').onclick = ()=>{
    const t=$('tokenGithub').value.trim();
    const owner=$('ghOwner').value.trim();
    const repo=$('ghRepo').value.trim();
    const path=$('ghPath').value.trim() || 'leader.json';
    if(!t){ toast('Masukkan token GitHub'); return; }
    if(!owner || !repo){ toast('Owner & repo harus diisi'); return; }
    localStorage.setItem(KEY_GITHUB, t);
    localStorage.setItem(KEY_GH_OWNER, owner);
    localStorage.setItem(KEY_GH_REPO, repo);
    localStorage.setItem(KEY_GH_PATH, path);
    $('gitStatus').textContent = 'Token GitHub tersimpan.';
    toast('Token GitHub & repo disimpan');
    log('Token GitHub disimpan ‚úÖ','ok');
  };

  $('testGit').onclick = async ()=>{
    const t = localStorage.getItem(KEY_GITHUB) || $('tokenGithub').value.trim();
    if(!t){ toast('Token GitHub belum diisi'); return; }
    try{
      const r = await fetch('https://api.github.com/user', { headers: { Authorization: 'token '+t }});
      if(r.ok){ const j=await r.json(); toast('GitHub OK: '+j.login); log('GitHub token valid: '+j.login,'ok'); }
      else { const j=await r.json(); toast('GitHub Test Error: '+(j.message||r.status)); log('GitHub test error: '+(j.message||r.status),'err'); }
    }catch(e){ toast('Tes GitHub gagal: '+e.message); log('Tes GitHub gagal: '+e.message,'err'); }
  };

  // --- Cache leader helpers ---
  function loadLeaders(){
    try{ return JSON.parse(localStorage.getItem(KEY_LEADERS) || '[]'); }
    catch(e){ return []; }
  }
  function saveLeaders(arr){
    localStorage.setItem(KEY_LEADERS, JSON.stringify(arr,null,2));
    updateLeadCount(arr.length);
    $('cacheInfo').textContent = arr.length ? arr.length + ' mitra (cache lokal)' : '(belum ada data)';
  }

  // --- Add Mitra modal ---
  $('btnAdd').onclick = ()=> $('modalAdd').style.display = 'flex';
  $('modalCancel').onclick = ()=> $('modalAdd').style.display = 'none';
  $('modalSave').onclick = ()=>{
    const name = $('m_name').value.trim();
    const phone = $('m_phone').value.trim();
    const idno = $('m_id').value.trim();
    if(!name || !phone){ toast('Nama & No HP wajib diisi'); return; }
    const arr = loadLeaders();
    const entry = { name, phone, idno, ts: Date.now() };
    arr.push(entry);
    saveLeaders(arr);
    log(`Mitra baru disimpan ke cache: ${name} ‚Ä¢ ${phone}`, 'ok');
    toast('Mitra disimpan di cache lokal');
    // clear & close
    $('m_name').value=''; $('m_phone').value=''; $('m_id').value='';
    $('modalAdd').style.display='none';
  };

  // open cache
  $('btnOpenCache').onclick = ()=> {
    const arr = loadLeaders();
    const w = window.open('', '_blank');
    w.document.write('<pre style="font-family:monospace">'+JSON.stringify(arr,null,2)+'</pre>');
    w.document.title = 'Cache Leaders';
  };
  $('btnExport').onclick = ()=>{
    const arr = loadLeaders();
    const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'leaders_cache.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    toast('Export cache siap di-download');
  };

  // --- GitHub sync (append/update file) ---
  async function fetchGitContent(){
    const token = localStorage.getItem(KEY_GITHUB);
    const owner = localStorage.getItem(KEY_GH_OWNER);
    const repo = localStorage.getItem(KEY_GH_REPO);
    const path = localStorage.getItem(KEY_GH_PATH) || 'leader.json';
    if(!token || !owner || !repo) throw new Error('Token GitHub / owner / repo belum lengkap');
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const r = await fetch(url, { headers: { Authorization: 'token '+token, Accept:'application/vnd.github.v3+json' }});
    if(r.status === 404) return null; // file belum ada
    if(!r.ok) throw await r.json();
    return await r.json();
  }

  async function pushGitContent(contentObj, message='Update leaders via NPA Smart'){
    // contentObj is JSON object => will be serialized to base64
    const token = localStorage.getItem(KEY_GITHUB);
    const owner = localStorage.getItem(KEY_GH_OWNER);
    const repo = localStorage.getItem(KEY_GH_REPO);
    const path = localStorage.getItem(KEY_GH_PATH) || 'leader.json';
    if(!token || !owner || !repo) throw new Error('Token GitHub / owner / repo belum lengkap');
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const payload = {
      message,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2)))) // base64
    };

    // If file exists, include sha (fetch it first)
    const existing = await fetchGitContent();
    if(existing && existing.sha) payload.sha = existing.sha;

    const r = await fetch(url, {
      method: 'PUT',
      headers: { Authorization: 'token '+token, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw await r.json();
    return await r.json();
  }

  // Manual sync button
  $('syncNow').onclick = async ()=>{
    toast('Mulai sinkronisasi ke GitHub...');
    log('Sinkronisasi mulai...', 'mono');
    try{
      const cached = loadLeaders();
      if(!cached.length) { toast('Cache kosong, tidak ada data untuk sinkronisasi'); log('Sinkron kosong, skip', 'warn'); return; }
      // fetch existing file (if any) and merge by appending (simple logic: concat)
      const existingMeta = await fetchGitContent().catch(e=>{ throw e; });
      let finalArr = cached;
      if(existingMeta && existingMeta.content){
        const decoded = decodeURIComponent(escape(atob(existingMeta.content.replace(/\n/g,''))));
        try{
          const remote = JSON.parse(decoded);
          // If remote is array -> merge (concatenate remote + cached, but dedupe by phone)
          if(Array.isArray(remote)){
            const map = {};
            remote.forEach(r=>{ if(r.phone) map[r.phone]=r; else map[r.ts||Math.random()]=r; });
            cached.forEach(c=>{ if(c.phone) map[c.phone]=c; else map[c.ts||Math.random()]=c; });
            finalArr = Object.values(map);
          } else {
            // remote not array -> overwrite with cached
            finalArr = cached;
          }
        } catch(e){
          // parse failed ‚Äî we will overwrite with cached
          finalArr = cached;
        }
      }
      // push finalArr
      const res = await pushGitContent(finalArr, `npa-sync: update leaders (${new Date().toISOString()})`);
      log('Sinkronisasi sukses. Commit: '+res.commit?.sha, 'ok');
      toast('Sinkronisasi ke GitHub berhasil.');
    }catch(err){
      console.error(err);
      const msg = err?.message || (err?.message) || JSON.stringify(err);
      log('Sinkron gagal: '+msg, 'err');
      toast('Sinkron gagal: '+ (err?.message || 'error'));
    }
  };

  // --- Auto follow-up scheduler: will only run while page open ---
  function sampleTemplate(type){
    if(type==='pagi') return "üí´ Motivasi Pagi: Mulai hari ini dengan niat, lakukan satu langkah kecil yang konsisten. Semangat!";
    return "üåá Motivasi Sore: Syukuri capaian hari ini. Istirahat yang cukup, bangun besok dengan semangat baru.";
  }
  async function sendFollowUp(type, manual=false){
    // In real integration, this would POST to FonNTE API with token and list of leaders.
    // Here we simulate and log. If token exists, we indicate "sent".
    const t = localStorage.getItem(KEY_FONNTE);
    const leaders = loadLeaders();
    const msg = (type==='pagi') ? sampleTemplate('pagi') : sampleTemplate('sore');
    if(!leaders.length){
      log(`Tidak ada mitra di cache. ${manual? 'Manual':'Auto'} ${type} skipped`, 'warn');
      toast('Tidak ada mitra: pesan tidak dikirim');
      return;
    }
    if(!t){
      log(`Token FonNTE belum diset. ${manual? 'Manual':'Auto'} ${type} tidak terkirim`, 'err');
      toast('Token FonNTE belum diset ‚Äî pesan tidak dikirim');
      return;
    }
    // Simulasi pengiriman per leader (boleh diganti implementasi fetch ke FonNTE)
    for(const l of leaders){
      // In production: call fetch FonNTE with bearer token and message
      log(`[kirim->${l.phone}] ${msg}`, 'mono');
    }
    toast(`${manual? 'Manual':'Auto'} ${type} terkirim ke ${leaders.length} mitra (simulasi)`);
  }

  $('sendPagi').onclick = ()=> sendFollowUp('pagi', true);
  $('sendSore').onclick = ()=> sendFollowUp('sore', true);

  // Auto schedule check each minute
  setInterval(()=>{
    const now=new Date();
    const hh = now.getHours();
    const mm = now.getMinutes();
    // run at 06:00 and 17:00 exactly
    if(hh===6 && mm===0) sendFollowUp('pagi', false);
    if(hh===17 && mm===0) sendFollowUp('sore', false);
  }, 60*1000);

  // initial log
  log('Admin v7.5 ter-load ‚úÖ', 'ok');

  // Expose for debugging
  window.NPA = {
    loadLeaders, saveLeaders, pushGitContent, fetchGitContent, sendFollowUp
  };

})();
</script>
</body>
</html>
