<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NPA Admin Pusat ‚Äî v7.2 (Dark Elegant)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220; --card:#071028; --panel:#0f1724; --muted:#a3b0c6; --accent:#0ea5e9;
  --glass: rgba(255,255,255,0.04);
  --success:#16a34a; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#071026 0%, #08122a 60%);color:#e6eef8;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:28px auto;padding:22px}
.header{display:flex;gap:16px;align-items:center;justify-content:space-between}
.title{font-size:20px;font-weight:700}
.sub{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small{font-size:13px;color:var(--muted)}
.field{display:flex;flex-direction:column;margin-bottom:10px}
label{font-weight:600;font-size:13px;color:#dbe9fb;margin-bottom:6px}
input[type=text], input[type=tel], input[type=password], select {background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:#e9f6ff}
.btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--accent),#1e40af);color:#04263a}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#d3e9ff}
.btn-warn{background:var(--danger);color:white}
.row{display:flex;gap:8px;flex-wrap:wrap}
.list{max-height:460px;overflow:auto;margin-top:10px}
.leader-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
.leader-left{display:flex;gap:12px;align-items:center}
.avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#1e40af);display:flex;align-items:center;justify-content:center;font-weight:700;color:#041427}
.leader-meta{line-height:1}
.meta-name{font-weight:700}
.meta-sub{font-size:12px;color:var(--muted)}
.links{display:flex;gap:8px;align-items:center}
.link-btn{padding:8px 10px;border-radius:10px;border:0;cursor:pointer;background:rgba(255,255,255,0.03);color:#cfefff;font-weight:700;font-size:13px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:#cfefff;font-size:13px}
.toast-wrap{position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#0ea5e9;color:#041427;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(14,165,233,0.12);font-weight:700}
.log{max-height:220px;overflow:auto;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:8px;font-size:13px;color:var(--muted)}
.notice{background:linear-gradient(90deg,#07203a,#051028);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-size:13px;margin-top:8px;color:var(--muted)}
.copy-ok{color:var(--success);font-weight:700;font-size:13px}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
@media (max-width:980px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">NPA Smart ‚Äî Admin Pusat v7.2</div>
        <div class="sub">Dark elegant ‚Äî kontrol leader, generate link, FonNTE + GitHub sync (opsional)</div>
      </div>
      <div class="small">Sugiarto Kurniawan ¬∑ NPA Smart System</div>
    </div>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div>
        <div class="card">
          <h3 style="margin:0 0 8px">üîê Token & Integrasi</h3>
          <div class="field">
            <label>Token FonNTE (untuk kirim WA)</label>
            <input id="fonnte_token" placeholder="Masukkan token FonNTE (disimpan lokal)">
          </div>
          <div class="field">
            <label>GitHub ‚Äî Owner / Repo</label>
            <div class="row">
              <input id="gh_owner" type="text" placeholder="owner (contoh: 3ireborn)" style="flex:1" />
              <input id="gh_repo" type="text" placeholder="repo (contoh: pendaftaran-online)" style="flex:1" />
            </div>
          </div>
          <div class="field">
            <label>GitHub Token (opsional, untuk sync)</label>
            <input id="gh_token" type="password" placeholder="Personal access token (repo :contents)"/>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-primary" id="saveFonnte">Simpan Token FonNTE</button>
            <button class="btn btn-ghost" id="testFonnte">Tes Kirim (dummy)</button>
            <button class="btn btn-ghost" id="saveGH">Simpan GitHub Info</button>
            <button class="btn btn-ghost" id="syncGit">Sync leaders ‚Üí GitHub</button>
          </div>
          <div class="notice">
            <strong>Catatan:</strong> Token disimpan di <code>localStorage</code> per perangkat. Tombol <em>Sync</em> akan mencoba update file <code>/data/leaders.json</code> di repository (butuh token & hak akses).
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">‚ûï Tambah Leader (cepat)</h3>
          <div class="row">
            <input id="new_name" type="text" placeholder="Nama leader (contoh: Sugiarto Kurniawan)" style="flex:2" />
            <input id="new_phone" type="tel" placeholder="628..." style="flex:1" />
          </div>
          <div style="margin-top:10px" class="row">
            <button class="btn btn-primary" id="addLeaderBtn">Tambah & Buat Link</button>
            <button class="btn btn-ghost" id="refreshLeaders">Refresh</button>
          </div>
          <div class="small" style="margin-top:8px">Slug dibuat otomatis dari nama (lowercase, tanpa spasi). Kamu bisa edit slug di file <code>data/leaders.json</code> jika perlu.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">üì£ Broadcast & Scheduler</h3>
          <div class="small">Auto-scheduler: <strong>06:00</strong> & <strong>17:00</strong> WIB (aktif saat halaman terbuka)</div>
          <div style="margin-top:8px" class="row">
            <button class="btn btn-primary" id="broadcastNow">Broadcast Manual (All)</button>
            <button class="btn btn-ghost" id="motivatePagi">Kirim Motivasi Pagi (Manual)</button>
            <button class="btn btn-ghost" id="motivateSore">Kirim Motivasi Sore (Manual)</button>
          </div>
          <div class="notice" style="margin-top:8px">
            Pesan akan dikirim via FonNTE API jika token terpasang; jika tidak, hanya tercatat di log.
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">üìù Log Aktivitas</h3>
          <div id="logArea" class="log">(belum ada aktivitas)</div>
        </div>

      </div>

      <!-- RIGHT: Leaders list & links -->
      <div>
        <div class="card">
          <h3 style="margin:0 0 8px">üë• Leader (data)</h3>
          <div class="small">Sumber: <code>/data/leaders.json</code> (fetch) ‚Üí fallback ke localStorage bila fetch gagal</div>
          <div class="list" id="leaderList"></div>

          <div style="margin-top:12px">
            <div class="field">
              <label>Contoh output link (klik untuk buka / copy)</label>
              <div id="linkPreview" class="mono">Pilih leader lalu klik "Generate Links"</div>
            </div>
            <div class="row" style="margin-top:8px">
              <button class="btn btn-primary" id="genAllLinks">Generate Semua Link</button>
              <button class="btn btn-ghost" id="copyAll">Copy Semua (terformat)</button>
            </div>
            <div id="copyMsg" class="small" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">‚ÑπÔ∏è Petunjuk Penting</h3>
          <div class="small">
            - <strong>Tidak</strong> mengubah struktur form pendaftaran final (v3.3).<br>
            - Pastikan nomor WA berformat internasional (contoh: 6281234...). Hati-hati copy dari Excel yang memangkas angka nol di akhir.<br>
            - Jika mau sinkron ke GitHub: masukkan owner/repo & token yang memiliki akses untuk mengubah file di repo. Gunakan hati-hati.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">NPA Smart System ‚Ä¢ 3iReborn ‚Äî Admin v7.2</div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

<script>
(() => {
  const TZ = "Asia/Jakarta";
  const API_FONNTE = "https://api.fonnte.com/send"; // Fonnte base
  const leaderListEl = document.getElementById('leaderList');
  const logArea = document.getElementById('logArea');
  const toastWrap = document.getElementById('toastWrap');
  function toast(msg){ const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toastWrap.appendChild(d); setTimeout(()=>d.remove(),4800); }
  function log(msg){ const t=new Date().toLocaleTimeString('id-ID',{timeZone:TZ,hour12:false}); logArea.innerHTML = '['+t+'] '+msg + '<br>' + logArea.innerHTML; }

  // Utilities
  function slugify(name){ return name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,''); }
  function codeFromName(name, idx){ const initials = name.split(' ').map(s=>s[0]||'').join('').slice(0,3).toUpperCase(); return initials + ('00'+(idx+1)).slice(-3); }
  function saveLocalLeaders(arr){ localStorage.setItem('npa_leaders', JSON.stringify(arr)); }

  // Load initial leaders: try fetch /data/leaders.json then fallback to localStorage or built-in
  async function loadLeaders(){
    let leaders = [];
    try{
      const r = await fetch('./data/leaders.json?ts=' + Date.now(), {cache:'no-store'});
      if(r.ok){
        leaders = await r.json();
        // normalize format (allow older shapes)
        leaders = leaders.map((l,i) => {
          if(l.name && l.phone && l.slug) return l;
          // older simple shape
          return {
            name: l.name || l.name,
            phone: l.phone || l.phone || l.phone,
            slug: l.slug || slugify(l.name || ('leader-'+(i+1))),
            code: l.code || codeFromName(l.name || ('Leader'+(i+1)), i)
          };
        });
        saveLocalLeaders(leaders);
        log('Leaders loaded from /data/leaders.json');
      } else {
        throw new Error('fetch failed');
      }
    } catch(e){
      // fallback to localStorage
      const cached = localStorage.getItem('npa_leaders');
      if(cached){
        try{ leaders = JSON.parse(cached); log('Leaders loaded from localStorage'); }
        catch(err){ leaders = []; log('Gagal parse cache leaders'); }
      } else {
        // default empty
        leaders = [];
        log('No leaders.json found ‚Äî start kosong (tambah leader via form)');
      }
    }
    renderLeaders(leaders);
    return leaders;
  }

  function renderLeaders(list){
    leaderListEl.innerHTML = '';
    if(!Array.isArray(list) || list.length===0){
      leaderListEl.innerHTML = '<div class="small">(belum ada leader ‚Äî tambahkan dengan form di kiri)</div>';
      document.getElementById('leadCount') && (document.getElementById('leadCount').textContent = '0');
      return;
    }
    document.getElementById('leadCount') && (document.getElementById('leadCount').textContent = list.length);
    list.forEach((l, idx) => {
      const div = document.createElement('div'); div.className='leader-item';
      const left = document.createElement('div'); left.className='leader-left';
      const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent = (l.name||'L').split(' ').map(p=>p[0]||'').slice(0,2).join('');
      const meta = document.createElement('div'); meta.className='leader-meta';
      const n = document.createElement('div'); n.className='meta-name'; n.textContent = l.code ? (l.code + ' ‚Ä¢ ' + l.name) : l.name;
      const s = document.createElement('div'); s.className='meta-sub'; s.textContent = (l.phone || '') + ' ‚Ä¢ slug: ' + (l.slug || '');
      meta.appendChild(n); meta.appendChild(s);
      left.appendChild(avatar); left.appendChild(meta);

      const right = document.createElement('div'); right.className='links';
      const genBtn = document.createElement('button'); genBtn.className='link-btn'; genBtn.textContent='Generate Links';
      genBtn.onclick = ()=> generateForLeader(l);
      const copyBtn = document.createElement('button'); copyBtn.className='link-btn'; copyBtn.textContent='Copy Link';
      copyBtn.onclick = ()=> { copyText(formatLinks(l)); toast('Copied links for ' + l.name); }
      right.appendChild(genBtn); right.appendChild(copyBtn);

      div.appendChild(left); div.appendChild(right);
      leaderListEl.appendChild(div);
    });
  }

  function formatLinks(l){
    const base = location.origin + location.pathname.replace(/\/[^/]*$/, '/');
    // choose the latest filenames if you changed naming; keep it flexible:
    const lpMaster = `${location.origin}/pendaftaran-online/lp-master-v6.6.html?name=${encodeURIComponent(l.name)}&wa=${encodeURIComponent(l.phone)}&slug=${encodeURIComponent(l.slug)}`;
    const lpHot = `${location.origin}/pendaftaran-online/lp-hot-v6.6.html?name=${encodeURIComponent(l.name)}&wa=${encodeURIComponent(l.phone)}&slug=${encodeURIComponent(l.slug)}`;
    const form = `${location.origin}/pendaftaran-online/form-pendaftaran-v3.1.html?name=${encodeURIComponent(l.name)}&wa=${encodeURIComponent(l.phone)}&slug=${encodeURIComponent(l.slug)}`;
    return `üåê LP Master: ${lpMaster}\n\nüî• LP Hot: ${lpHot}\n\nüìù Form Pendaftaran: ${form}`;
  }

  function generateForLeader(l){
    const out = formatLinks(l);
    document.getElementById('linkPreview').textContent = out;
    toast('Links dibuat untuk ' + l.name);
    log('Generated links for ' + l.name);
  }

  function copyText(txt){
    try{
      const ta = document.createElement('textarea'); ta.value = txt; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      document.getElementById('copyMsg').textContent = 'Copied ‚úî';
      setTimeout(()=>document.getElementById('copyMsg').textContent='',1600);
    } catch(e){ toast('Copy gagal'); }
  }

  // Add leader
  document.getElementById('addLeaderBtn').addEventListener('click', async ()=>{
    const name = (document.getElementById('new_name').value || '').trim();
    const phone = (document.getElementById('new_phone').value || '').trim().replace(/\s+/g,'');
    if(!name || !phone){ alert('Isi nama dan nomor WA (628...)'); return; }
    const cached = JSON.parse(localStorage.getItem('npa_leaders')||'[]');
    const slug = slugify(name);
    const item = { name, phone, slug, code: codeFromName(name, cached.length) };
    cached.unshift(item);
    saveLocalLeaders(cached);
    renderLeaders(cached);
    document.getElementById('new_name').value=''; document.getElementById('new_phone').value='';
    generateForLeader(item);
    log('Leader ditambahkan: ' + name);
    toast('Leader ditambahkan ‚úî');
  });

  document.getElementById('refreshLeaders').addEventListener('click', ()=> loadLeaders());

  // generate all
  document.getElementById('genAllLinks').addEventListener('click', ()=>{
    const arr = JSON.parse(localStorage.getItem('npa_leaders')||'[]');
    if(!arr.length){ toast('Belum ada leader'); return; }
    let text = '';
    arr.forEach(l=> text += formatLinks(l) + '\n\n');
    document.getElementById('linkPreview').textContent = text;
    toast('Semua link ter-generate');
    log('Generate semua links');
  });
  document.getElementById('copyAll').addEventListener('click', ()=>{
    const text = document.getElementById('linkPreview').textContent || '';
    if(!text) return toast('Nothing to copy');
    copyText(text);
  });

  // FonNTE token io
  document.getElementById('saveFonnte').addEventListener('click', ()=>{
    const t = document.getElementById('fonnte_token').value.trim();
    if(t.length < 10) return alert('Token terlalu pendek');
    localStorage.setItem('fonnte_token', t);
    toast('Token FonNTE tersimpan');
    log('Token FonNTE disimpan di perangkat ini');
  });
  document.getElementById('testFonnte').addEventListener('click', async ()=>{
    const token = localStorage.getItem('fonnte_token') || '';
    if(!token) return alert('Token belum diset');
    // dummy send (jangan kirim real tanpa izin)
    toast('Tes FonNTE: token terdeteksi (dummy)');
    log('Tes token FonNTE (dummy)');
  });

  // GitHub save (sync leaders to /data/leaders.json)
  document.getElementById('saveGH').addEventListener('click', ()=>{
    const owner = document.getElementById('gh_owner').value.trim();
    const repo = document.getElementById('gh_repo').value.trim();
    const token = document.getElementById('gh_token').value.trim();
    if(!owner || !repo || !token) return alert('Isi owner/repo/token GitHub');
    localStorage.setItem('gh_owner', owner); localStorage.setItem('gh_repo', repo); localStorage.setItem('gh_token', token);
    toast('GitHub info disimpan (lokal)');
    log('GitHub info disimpan (local)');
  });

  // Sync to GitHub: PUT /repos/{owner}/{repo}/contents/{path}
  document.getElementById('syncGit').addEventListener('click', async ()=>{
    const owner = localStorage.getItem('gh_owner');
    const repo = localStorage.getItem('gh_repo');
    const token = localStorage.getItem('gh_token');
    if(!owner||!repo||!token) return alert('Owner/repo/token belum diset via "Simpan GitHub Info"');
    const path = 'data/leaders.json';
    const contentArr = JSON.parse(localStorage.getItem('npa_leaders') || '[]');
    const body = btoa(unescape(encodeURIComponent(JSON.stringify(contentArr, null, 2))));
    // Need to get current sha first (optional) -> we'll try GET then PUT
    try{
      // get existing file sha
      const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const r = await fetch(getUrl, { headers: { Authorization: 'token ' + token }});
      let sha = null;
      if(r.ok){
        const j = await r.json(); sha = j.sha;
      }
      const putRes = await fetch(getUrl, {
        method: 'PUT',
        headers: {
          Authorization: 'token ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'Update leaders.json via NPA Admin v7.2',
          content: body,
          sha: sha
        })
      });
      if(putRes.ok){
        toast('Sync sukses ‚úî');
        log('Sync to GitHub sukses');
      } else {
        const err = await putRes.json();
        alert('Sync gagal: ' + (err.message || putRes.statusText));
        log('Sync gagal: ' + (err.message || putRes.statusText));
      }
    } catch(e){
      alert('Sync error: ' + e.message);
      log('Sync error: ' + e.message);
    }
  });

  // Broadcast + scheduler
  const MOTIVATIONS = [
    "üí´ Hari baru, semangat baru ‚Äî teruslah melangkah!",
    "üåÖ Jangan takut gagal, takutlah bila berhenti mencoba.",
    "üî• Konsistensi kecil > impuls besar. Tetap jalan!",
    "üí™ Siapkan hari ini untuk menuai esok yang lebih baik."
  ];
  function pickMotivation(){ return MOTIVATIONS[Math.floor(Math.random()*MOTIVATIONS.length)]; }
  async function sendViaFonnte(target, text){
    const token = localStorage.getItem('fonnte_token') || '';
    if(!token) throw new Error('Token FonNTE belum diset');
    await fetch(API_FONNTE, {
      method: 'POST',
      headers: { 'Authorization': token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ target, message: text })
    });
  }

  async function broadcastAll(msg){
    const arr = JSON.parse(localStorage.getItem('npa_leaders')||'[]');
    if(!arr.length) { toast('Tidak ada leader di cache'); return; }
    for(const l of arr){
      try{
        if(localStorage.getItem('fonnte_token')){
          await sendViaFonnte(l.phone, msg + `\n\nSmart Auto Broadcast by 3iReborn || NPA Team`);
          log('Terkirim ke ' + l.phone);
        } else {
          log('(sim) -> ' + l.phone + ': ' + msg);
        }
      } catch(e){
        log('Gagal kirim ke ' + l.phone + ' : ' + e.message);
      }
    }
    toast('Broadcast selesai');
  }

  document.getElementById('broadcastNow').addEventListener('click', async ()=>{
    const msg = prompt('Masukkan pesan broadcast singkat:', pickMotivation());
    if(!msg) return;
    log('Manual broadcast dimulai');
    await broadcastAll(msg);
  });
  document.getElementById('motivatePagi').addEventListener('click', async ()=> {
    const m = pickMotivation();
    log('Manual motivasi pagi: ' + m);
    await broadcastAll(m);
  });
  document.getElementById('motivateSore').addEventListener('click', async ()=> {
    const m = pickMotivation();
    log('Manual motivasi sore: ' + m);
    await broadcastAll(m);
  });

  // Auto scheduler (runs while page open)
  let lastAutoDay = null;
  setInterval(async ()=>{
    const now = new Date(new Date().toLocaleString("en-US", { timeZone: TZ }));
    const hh = now.getHours(), mm = now.getMinutes();
    const dayKey = now.toDateString();
    // morning 06:00
    if(hh===6 && mm===0 && lastAutoDay !== dayKey + '-6'){
      lastAutoDay = dayKey + '-6';
      const msg = pickMotivation();
      log('Auto 06:00 -> ' + msg);
      await broadcastAll(msg);
    }
    // evening 17:00
    if(hh===17 && mm===0 && lastAutoDay !== dayKey + '-17'){
      lastAutoDay = dayKey + '-17';
      const msg = pickMotivation();
      log('Auto 17:00 -> ' + msg);
      await broadcastAll(msg);
    }
  }, 60*1000); // check per menit

  // Init: load leaders from file or cache
  (async ()=>{
    // try load
    await loadLeaders();
  })();

  // Helper: copy when click links in preview
  document.getElementById('linkPreview').addEventListener('click', (e)=>{
    const text = e.target.textContent || e.target.innerText;
    if(text) copyText(text);
  });

})();
</script>
</body>
</html>
